<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”œç”œçš„é­”æ³•æ•…äº‹ä¹å›­ (V14.2 - Gisté“¾æ¥æ›´æ–°)</title>
    <style>
        :root { 
            --primary-bg-color: #e0f7fa; --primary-text-color: #004d40; --theme-accent-color: #00bcd4;
            --feature-bg-color: #ffffff; --feature-border-color: #b2ebf2; --gacha-button-text-color: #004d40; 
            --draw-method-bg-color: #e0f7fa; --draw-method-border-color: #00bcd4; 
            --draw-method-text-color: #00796b; --draw-method-hover-bg-color: #b2ebf2;
            --stamina-bar-bg-color: #00acc1; --story-content-bg-color: #f0f8ff;
            --story-content-border-color: #81d4fa; --placeholder-text-color: #546e7a;
            --story-title-color: var(--theme-accent-color); 
            --module-button-active-bg: var(--theme-accent-color); 
            --module-button-active-text: #ffffff; 
            --module-button-bg: #f0f0f0; 
            --module-button-text: var(--primary-text-color); 
            --pagination-btn-bg:#00bcd4;
            --pagination-btn-text: #ffffff;
            --pagination-btn-disabled-bg: #cccccc;
            --pagination-btn-disabled-text: #888888;
        }
        body { font-family: 'Microsoft YaHei', sans-serif; margin: 0; padding: 20px; background-color: var(--primary-bg-color); color: var(--primary-text-color); transition: background-color 0.5s ease, color 0.5s ease; }
        h1 { text-align: center; color: var(--theme-accent-color); margin-bottom: 30px; transition: color 0.5s ease; }
        h2 { color: var(--theme-accent-color); border-bottom: 2px solid var(--theme-accent-color); padding-bottom: 5px; margin-bottom: 15px; transition: color 0.5s ease, border-color 0.5s ease; }
        .feature-section { background-color: var(--feature-bg-color); border: 1px solid var(--feature-border-color); padding: 20px; margin-bottom: 20px; border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); transition: background-color 0.5s ease, border-color 0.5s ease; }
        .story-draw-methods { display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; }
        .draw-method { border: 2px dashed var(--draw-method-border-color); padding: 15px 25px; cursor: pointer; background-color: var(--draw-method-bg-color); color: var(--draw-method-text-color); border-radius: 8px; text-align: center; font-weight: bold; transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease; }
        .draw-method:hover:not(.disabled) { transform: translateY(-3px); box-shadow: 0 6px 12px rgba(0,0,0,0.1); background-color: var(--draw-method-hover-bg-color); }
        .draw-method.disabled { cursor: not-allowed; opacity: 0.6; background-color: #ccc !important; border-color: #aaa !important; color: #666 !important; box-shadow: none; transform: none; }
        .draw-method.is-grabbing { animation: claw-machine-rumble 0.7s ease-in-out; }
        @keyframes claw-machine-rumble { 0%, 100% { transform: translateX(0) rotate(0); } 15% { transform: translateX(-4px) rotate(-2deg); } 30% { transform: translateX(4px) rotate(2deg); } 45% { transform: translateX(-3px) rotate(-1deg); } 60% { transform: translateX(3px) rotate(1deg); } 75% { transform: translateX(-2px) rotate(0); } }
        .draw-method.dart-throw-animation { animation: dart-throw 0.5s ease-out; } @keyframes dart-throw { 0%, 100% { transform: translate(0,0) scale(1); } 50% { transform: translate(3px, -3px) scale(1.05); } }
        .draw-method.slot-spin-animation { animation: slot-spin 0.6s linear; } @keyframes slot-spin { 0%, 100% { transform: translateY(0); } 20% { transform: translateY(-4px); } 40% { transform: translateY(4px); }  60% { transform: translateY(-3px); } 80% { transform: translateY(3px); } }
        .draw-method.coin-flip-animation { animation: coin-flip 0.7s ease-in-out; } @keyframes coin-flip { 0% { transform: rotateY(0deg); } 100% { transform: rotateY(360deg); } }
        .draw-method.cat-paw-animation { animation: cat-paw-press 0.4s ease-in-out; } @keyframes cat-paw-press { 0%, 100% { transform: scale(1); box-shadow: 0 2px 5px rgba(0,0,0,0.1); } 50% { transform: scale(0.95, 0.92); box-shadow: inset 0 1px 3px rgba(0,0,0,0.2); } }
        .draw-method.balloon-wiggle-animation { animation: balloon-wiggle 0.7s ease-in-out; } @keyframes balloon-wiggle { 0%, 100% { transform: rotate(0deg) translateX(0); } 20% { transform: rotate(4deg) translateX(2px); } 40% { transform: rotate(-4deg) translateX(-2px); } 60% { transform: rotate(3deg) translateX(1px); } 80% { transform: rotate(-3deg) translateX(-1px); } }
        .theme-buttons .theme-btn { padding: 10px 18px; margin-right: 10px; margin-bottom: 10px; border: 2px solid transparent; border-radius: 8px; cursor: pointer; font-weight: bold; transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.3s ease, color 0.3s ease;}
        .theme-buttons .theme-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .theme-buttons .theme-btn.pink { background-color: #ffc0cb; color: #8B008B; } .theme-buttons .theme-btn.blue { background-color: #add8e6; color: #000080; }
        .theme-buttons .theme-btn.green { background-color: #90ee90; color: #006400; } .theme-buttons .theme-btn.orange { background-color: #ffd580; color: #A0522D; }
        .theme-buttons .theme-btn.purple { background-color: #e6e6fa; color: #483D8B; } .theme-buttons .theme-btn.yellow { background-color: #fffacd; color: #B8860B; }
        .theme-buttons .theme-btn.dark { background-color: #555555; color: #ffffff; }
        #stamina-bar-container { width: 100%; background-color: #e0e0e0; border-radius: 8px; height: 28px; overflow: hidden; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1); }
        #stamina-bar { width: 100%; height: 100%; background-color: var(--stamina-bar-bg-color); text-align: center; line-height: 28px; color: white; font-weight: bold; border-radius: 8px; transition: width 0.5s ease, background-color 0.5s ease; }
        #story-content { background-color: var(--story-content-bg-color); padding: 20px; border-left: 6px solid var(--story-content-border-color); min-height: 120px; border-radius: 0 8px 8px 0; transition: background-color 0.5s ease, border-color 0.5s ease; line-height: 1.6; }
        #story-content h3 { margin-top: 0; color: var(--story-title-color); transition: color 0.5s ease; }
        .placeholder-text { color: var(--placeholder-text-color); font-style: italic; font-size: 0.9em; transition: color 0.5s ease; }
        .loading-message { text-align: center; padding: 20px; font-style: italic; color: var(--placeholder-text-color); }
        .gacha-button { display: block; margin: 10px auto 20px auto; padding: 12px 28px; background-color: var(--theme-accent-color); color: var(--gacha-button-text-color); border: none; border-radius: 25px; font-size: 1.1em; font-weight: bold; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: transform 0.2s ease, background-color 0.3s ease, box-shadow 0.2s ease, color 0.3s ease; }
        .gacha-button:hover { transform: scale(1.05) translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.15); filter: brightness(110%); }
        .gacha-button:active { transform: scale(0.98) translateY(0px); }
        #prompt-gacha-display { background-color: var(--story-content-bg-color); border: 2px dashed var(--draw-method-border-color); padding: 25px; border-radius: 8px; min-height: 100px; display: flex; justify-content: center; align-items: center; text-align: center; font-size: 1.15em; color: var(--primary-text-color); line-height: 1.5; box-shadow: inset 0 0 10px rgba(0,0,0,0.03); transition: background-color 0.5s ease, border-color 0.5s ease, color 0.5s ease; }
        .shake-animation { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0) rotate(-1deg); } 20%, 80% { transform: translate3d(2px, 0, 0) rotate(1deg); } 30%, 50%, 70% { transform: translate3d(-2px, 0, 0) rotate(-2deg); } 40%, 60% { transform: translate3d(2px, 0, 0) rotate(2deg); } }
        #paperball-trigger { display: block; width: fit-content; padding: 15px 25px; background-color: var(--draw-method-bg-color); border: 2px dashed var(--draw-method-border-color); border-radius: 10px; cursor: pointer; text-align: center; font-size: 1.2em; font-weight: bold; margin: 0 auto 20px auto; color: var(--draw-method-text-color); transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.3s ease; }
        #paperball-trigger:hover { transform: scale(1.05); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .module-buttons-container { display: none; flex-wrap: wrap; gap: 15px; margin-top: 20px; margin-bottom: 20px; justify-content: center; }
        .module-btn { padding: 10px 20px; font-size: 1em; font-weight: bold; border: 2px solid var(--theme-accent-color); border-radius: 8px; cursor: pointer; background-color: var(--module-button-bg); color: var(--module-button-text); transition: background-color 0.3s ease, color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease; }
        .module-btn:hover { transform: translateY(-2px); filter: brightness(110%); }
        .module-btn.active { background-color: var(--module-button-active-bg); color: var(--module-button-active-text); box-shadow: 0 0 10px var(--module-button-active-bg); }
        .module-content { border: 1px dashed var(--feature-border-color); padding: 15px; margin-top: 10px; border-radius: 8px; background-color: var(--feature-bg-color); display: none; line-height: 1.6; transition: background-color 0.5s ease, border-color 0.5s ease; }
        .module-item-display { min-height: 150px; padding: 10px; margin-bottom: 15px; border-radius: 5px; }
        .module-item-display p, .module-item-display li { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px dotted var(--feature-border-color); }
        .module-item-display p > span:first-child, .module-item-display li > span:first-child { flex-grow: 1; margin-right: 10px; }
        .module-item-display p:last-child, .module-item-display li:last-child { margin-bottom: 0; padding-bottom: 0; border-bottom: none; }
        .module-pagination-controls { display: flex; justify-content: space-between; align-items: center; margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--feature-border-color); }
        .pagination-btn { padding: 8px 16px; background-color: var(--pagination-btn-bg); color: var(--pagination-btn-text); border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: background-color 0.3s ease, transform 0.2s ease, color 0.3s ease; }
        .pagination-btn:hover:not([disabled]) { filter: brightness(110%); transform: translateY(-1px); }
        .pagination-btn:disabled { background-color: var(--pagination-btn-disabled-bg) !important; color: var(--pagination-btn-disabled-text) !important; cursor: not-allowed; opacity: 0.7; }
        .page-info { font-weight: bold; color: var(--primary-text-color); }
        #persona-area { text-align: center; }
        .persona-claw-machine { display: inline-flex; flex-direction: column; align-items: center; padding: 20px; background-color: var(--draw-method-bg-color); border: 3px solid var(--draw-method-border-color); border-radius: 15px; cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; margin-bottom: 20px; box-shadow: 0 5px 10px rgba(0,0,0,0.1); }
        .persona-claw-machine:hover { transform: scale(1.03); box-shadow: 0 8px 15px rgba(0,0,0,0.15); }
        .persona-claw-machine .claw-emoji { font-size: 3em; margin-bottom: 10px; display: inline-block; }
        .persona-claw-machine p { margin: 0; font-weight: bold; color: var(--draw-method-text-color); }
        .persona-trait-display-area { margin-top: 15px; padding: 20px; background-color: var(--story-content-bg-color); border: 2px dashed var(--theme-accent-color); border-radius: 8px; min-height: 50px; display: flex; justify-content: center; align-items: center; text-align: center; font-size: 1.2em; font-weight: bold; color: var(--primary-text-color); }
        .persona-machine-shake { animation: machine-shake-strong 0.6s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes machine-shake-strong { 10%, 90% { transform: translate3d(-2px, 0, 0) rotate(-3deg); } 20%, 80% { transform: translate3d(3px, 0, 0) rotate(3deg); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0) rotate(-4deg); } 40%, 60% { transform: translate3d(4px, 0, 0) rotate(4deg); } }
        
        .copy-btn-item { margin-left: 10px; padding: 3px 8px; font-size: 0.8em; background-color: var(--draw-method-hover-bg-color); color: var(--draw-method-text-color); border: 1px solid var(--draw-method-border-color); border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease, color 0.2s ease; flex-shrink: 0; }
        .copy-btn-item:hover { filter: brightness(120%); }
        .copy-btn-module-all { margin-left: 15px; padding: 5px 10px; font-size: 0.9em; background-color: var(--theme-accent-color); color: var(--pagination-btn-text); border: none; border-radius: 5px; cursor: pointer; transition: background-color 0.2s ease, color 0.2s ease; }
        .copy-btn-module-all:hover { filter: brightness(110%); }
        .copy-btn-section { display: block; width: fit-content; margin: 15px auto 5px auto; padding: 8px 15px; font-size: 0.95em; font-weight: bold; background-color: var(--draw-method-bg-color); color: var(--draw-method-text-color); border: 2px dashed var(--draw-method-border-color); border-radius: 8px; cursor: pointer; transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease; }
        .copy-btn-section:hover { background-color: var(--draw-method-hover-bg-color); filter: brightness(105%); }
        .copied-feedback { background-color: #28a745 !important; color: white !important; border-color: #28a745 !important; }/* è™šæ‹Ÿæˆ¿é—´å’Œå® ç‰©æ ·å¼ */
#virtual-room-area { position: relative; }
#room-display { 
    width: 100%; 
    height: 300px; 
    border: 3px solid var(--draw-method-border-color); 
    border-radius: 15px; 
    position: relative; 
    overflow: hidden; 
    background: linear-gradient(135deg, var(--story-content-bg-color) 0%, var(--draw-method-bg-color) 100%);
    box-shadow: inset 0 0 20px rgba(0,0,0,0.1);
    margin-bottom: 20px;
}
#room-background {
    width: 100%;
    height: 100%;
    position: relative;
    transition: all 0.5s ease;
}
#pet-container {
    position: absolute;
    bottom: 60px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 10;
}
#virtual-pet {
    display: flex;
    flex-direction: column;
    align-items: center;
    cursor: pointer;
    transition: transform 0.3s ease;
}
#virtual-pet:hover {
    transform: scale(1.1);
}
#pet-emoji {
    font-size: 4em;
    display: block;
    margin-bottom: 10px;
    animation: float 3s ease-in-out infinite;
}
@keyframes float {
    0%, 100% { transform: translateY(0px); }
    50% { transform: translateY(-10px); }
}
@keyframes float-up {
    0% { opacity: 1; transform: translate(-50%, -50%) scale(0.5); }
    50% { opacity: 1; transform: translate(-50%, -80px) scale(1); }
    100% { opacity: 0; transform: translate(-50%, -120px) scale(0.5); }
}
#pet-status {
    background: rgba(255, 255, 255, 0.9);
    padding: 8px 12px;
    border-radius: 15px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    min-width: 120px;
}
.status-bar {
    display: flex;
    align-items: center;
    margin-bottom: 5px;
    gap: 8px;
}
.status-bar:last-child { margin-bottom: 0; }
.status-bar-bg {
    flex: 1;
    height: 12px;
    background: #e0e0e0;
    border-radius: 6px;
    overflow: hidden;
}
.status-bar-fill {
    height: 100%;
    border-radius: 6px;
    transition: width 0.5s ease, background-color 0.5s ease;
}
#pet-happiness { background: linear-gradient(90deg, #ff6b6b, #ff8e8e); }
#pet-hunger { background: linear-gradient(90deg, #4ecdc4, #6ee8dd); }
.status-bar span:last-child {
    font-weight: bold;
    min-width: 30px;
    text-align: center;
    font-size: 0.9em;
}
#room-items {
    position: absolute;
    width: 100%;
    height: 100%;
    pointer-events: none;
}
.room-item {
    position: absolute;
    font-size: 2em;
    cursor: pointer;
    pointer-events: all;
    transition: transform 0.2s ease;
    user-select: none;
}
.room-item:hover {
    transform: scale(1.2);
}
#food-bowl { bottom: 20px; left: 20px; }
#toy-ball { bottom: 20px; right: 20px; }
#bed { top: 20px; right: 20px; }
#pet-controls, #room-controls {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    justify-content: center;
    margin-bottom: 15px;
}
.pet-action-btn, .room-theme-btn {
    padding: 10px 20px;
    border: 2px solid var(--draw-method-border-color);
    border-radius: 20px;
    background: var(--draw-method-bg-color);
    color: var(--draw-method-text-color);
    cursor: pointer;
    font-weight: bold;
    transition: all 0.3s ease;
}
.pet-action-btn:hover, .room-theme-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    background: var(--draw-method-hover-bg-color);
}
.pet-action-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
}
.room-theme-btn.active {
    background: var(--theme-accent-color);
    color: white;
    box-shadow: 0 0 10px var(--theme-accent-color);
}

/* æˆ¿é—´ä¸»é¢˜æ ·å¼ */
.room-theme-cozy {
    background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%);
}
.room-theme-garden {
    background: linear-gradient(135deg, #a8e6cf 0%, #88d8a3 100%);
}
.room-theme-space {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}
.room-theme-ocean {
    background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
}

/* å® ç‰©åŠ¨ç”»æ•ˆæœ */
.pet-happy { animation: bounce 0.6s ease-in-out; }
@keyframes bounce {
    0%, 100% { transform: scale(1) translateX(-50%); }
    50% { transform: scale(1.2) translateX(-50%); }
}
.pet-eating { animation: shake-head 0.8s ease-in-out; }
@keyframes shake-head {
    0%, 100% { transform: translateX(-50%) rotate(0deg); }
    25% { transform: translateX(-50%) rotate(-5deg); }
    75% { transform: translateX(-50%) rotate(5deg); }
}
.pet-sleeping { animation: sleep-sway 2s ease-in-out infinite; }
@keyframes sleep-sway {
    0%, 100% { transform: translateX(-50%) rotate(-2deg); }
    50% { transform: translateX(-50%) rotate(2deg); }
}
/* å‡çº§çš„å® ç‰©å’Œæˆ¿é—´æ ·å¼ - æ·»åŠ åˆ°ä½ çš„CSSä¸­ */

/* è¯­éŸ³æ°”æ³¡ */
.speech-bubble {
    position: absolute;
    bottom: 95%;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(255, 255, 255, 0.95);
    border: 2px solid var(--theme-accent-color);
    border-radius: 20px;
    padding: 8px 15px;
    font-size: 0.9em;
    font-weight: bold;
    color: var(--primary-text-color);
    white-space: nowrap;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    animation: bubble-pop 0.3s ease-out;
    z-index: 1000;
}

.speech-bubble::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    border: 8px solid transparent;
    border-top-color: var(--theme-accent-color);
}

.speech-bubble.hidden {
    display: none;
}

@keyframes bubble-pop {
    0% { opacity: 0; transform: translateX(-50%) scale(0.8); }
    100% { opacity: 1; transform: translateX(-50%) scale(1); }
}

/* å¤©æ°”æ•ˆæœ */
#weather-effects {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    overflow: hidden;
}

.weather-particle {
    position: absolute;
    width: 100%;
    height: 100%;
    opacity: 0;
    transition: opacity 1s ease;
}

.weather-particle.active {
    opacity: 1;
}

/* é›¨æ»´æ•ˆæœ */
#rain.active::before {
    content: '';
    position: absolute;
    top: -100px;
    left: 0;
    width: 100%;
    height: calc(100% + 100px);
    background-image: 
        radial-gradient(2px 10px, #4fc3f7 50%, transparent 50%),
        radial-gradient(2px 10px, #29b6f6 50%, transparent 50%);
    background-size: 25px 50px, 30px 60px;
    animation: rain-fall 1s linear infinite;
}

@keyframes rain-fall {
    0% { background-position: 0 -100px, 5px -100px; }
    100% { background-position: 0 calc(100% + 100px), 5px calc(100% + 100px); }
}

/* é›ªèŠ±æ•ˆæœ */
#snow.active::before,
#snow.active::after {
    content: 'â„';
    position: absolute;
    top: -50px;
    font-size: 20px;
    color: #e3f2fd;
    animation: snow-fall 3s linear infinite;
}

#snow.active::before {
    left: 10%;
    animation-delay: 0s;
}

#snow.active::after {
    left: 80%;
    animation-delay: 1.5s;
    font-size: 16px;
}

@keyframes snow-fall {
    0% { transform: translateY(-50px) rotate(0deg); }
    100% { transform: translateY(350px) rotate(360deg); }
}

/* æ˜Ÿæ˜Ÿæ•ˆæœ */
#stars.active {
    background-image: 
        radial-gradient(2px 2px, #fff59d 50%, transparent 50%),
        radial-gradient(1px 1px, #ffeb3b 50%, transparent 50%),
        radial-gradient(1px 1px, #ffc107 50%, transparent 50%);
    background-size: 50px 50px, 80px 80px, 100px 100px;
    animation: twinkle 2s ease-in-out infinite alternate;
}

@keyframes twinkle {
    0% { opacity: 0.3; }
    100% { opacity: 0.8; }
}

/* å‡çº§çš„æˆ¿é—´ç‰©å“ */
#fish-tank {
    top: 40%;
    left: 15%;
    animation: fish-swim 3s ease-in-out infinite;
}

@keyframes fish-swim {
    0%, 100% { transform: scale(1) rotate(0deg); }
    50% { transform: scale(1.1) rotate(5deg); }
}

#plant {
    bottom: 60px;
    left: 70%;
    animation: plant-grow 4s ease-in-out infinite;
}

@keyframes plant-grow {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.15); }
}

#music-box {
    top: 30px;
    left: 75%;
    animation: music-bounce 2s ease-in-out infinite;
}

@keyframes music-bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-5px); }
}

/* æ–°æˆ¿é—´ä¸»é¢˜ */
.room-theme-candy {
    background: linear-gradient(135deg, #f8bbd9 0%, #e91e63 50%, #ad1457 100%);
}

.room-theme-forest {
    background: linear-gradient(135deg, #c8e6c9 0%, #4caf50 50%, #2e7d32 100%);
}

/* ç‰¹æ•ˆå®¹å™¨ */
#effects-container {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 100;
}

/* æµ®åŠ¨ç‰¹æ•ˆ */
.floating-effect {
    position: absolute;
    font-size: 1.5em;
    pointer-events: none;
    animation: float-away 2s ease-out forwards;
    z-index: 1000;
}

@keyframes float-away {
    0% {
        opacity: 1;
        transform: scale(0.5) translateY(0);
    }
    50% {
        opacity: 1;
        transform: scale(1) translateY(-30px);
    }
    100% {
        opacity: 0;
        transform: scale(0.5) translateY(-60px);
    }
}

/* å¤©æ°”æ§åˆ¶æŒ‰é’® */
#weather-controls {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    justify-content: center;
    margin-bottom: 15px;
}

.weather-btn {
    padding: 8px 16px;
    border: 2px solid var(--draw-method-border-color);
    border-radius: 15px;
    background: var(--draw-method-bg-color);
    color: var(--draw-method-text-color);
    cursor: pointer;
    font-weight: bold;
    transition: all 0.3s ease;
    font-size: 0.9em;
}

.weather-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    background: var(--draw-method-hover-bg-color);
}

.weather-btn.active {
    background: var(--theme-accent-color);
    color: white;
    box-shadow: 0 0 10px var(--theme-accent-color);
}

/* å® ç‰©ä¿¡æ¯é¢æ¿ */
#pet-info-panel {
    background: rgba(255, 255, 255, 0.9);
    border: 2px solid var(--feature-border-color);
    border-radius: 10px;
    padding: 15px;
    margin: 15px 0;
    backdrop-filter: blur(5px);
}

#pet-info-panel h3 {
    margin-top: 0;
    color: var(--theme-accent-color);
    text-align: center;
}

.pet-trait {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    padding: 5px 0;
    border-bottom: 1px dotted var(--feature-border-color);
}

.trait-label {
    font-weight: bold;
    color: var(--primary-text-color);
}

/* å‡çº§çš„å® ç‰©åŠ¨ç”» */
.pet-excited {
    animation: excited-bounce 0.6s ease-in-out 3;
}

@keyframes excited-bounce {
    0%, 100% { transform: translateX(-50%) scale(1) rotate(0deg); }
    25% { transform: translateX(-50%) scale(1.2) rotate(-5deg); }
    75% { transform: translateX(-50%) scale(1.2) rotate(5deg); }
}

.pet-sleepy {
    animation: sleepy-sway 3s ease-in-out infinite;
    opacity: 0.8;
}

@keyframes sleepy-sway {
    0%, 100% { transform: translateX(-50%) rotate(-3deg); }
    50% { transform: translateX(-50%) rotate(3deg); }
}

.pet-dancing {
    animation: dance 1s ease-in-out 3;
}

@keyframes dance {
    0%, 100% { transform: translateX(-50%) rotate(0deg) scale(1); }
    25% { transform: translateX(-50%) rotate(-10deg) scale(1.1); }
    50% { transform: translateX(-50%) rotate(0deg) scale(1.2); }
    75% { transform: translateX(-50%) rotate(10deg) scale(1.1); }
}

/* å¿ƒå½¢ç‰¹æ•ˆ */
.heart-effect {
    color: #e91e63;
    animation: heart-float 2s ease-out forwards;
}

@keyframes heart-float {
    0% {
        opacity: 1;
        transform: scale(0.5) translateY(0) rotate(0deg);
    }
    50% {
        opacity: 1;
        transform: scale(1.2) translateY(-40px) rotate(180deg);
    }
    100% {
        opacity: 0;
        transform: scale(0.8) translateY(-80px) rotate(360deg);
    }
}

/* èƒ½é‡å€¼æ ·å¼ */
#pet-energy {
    background: linear-gradient(90deg, #9c27b0, #e1bee7);
}

/* å“åº”å¼ä¼˜åŒ– */
@media (max-width: 768px) {
    .speech-bubble {
        font-size: 0.8em;
        padding: 6px 12px;
    }
    
    #pet-info-panel {
        margin: 10px 0;
        padding: 10px;
    }
    
    .weather-btn, .pet-action-btn {
        font-size: 0.8em;
        padding: 6px 12px;
    }
}
    </style>
</head>
<body>
    <h1>æ¬¢è¿æ¥åˆ°ç”œç”œçš„é­”æ³•æ•…äº‹ä¹å›­ï¼</h1>
<div class="feature-section" id="virtual-room-area">
    <h2>ğŸ  æˆ‘çš„é­”æ³•å°å±‹</h2>
    <div id="room-display">
        <div id="room-background">
            <!-- å¤©æ°”ç³»ç»Ÿ -->
            <div id="weather-effects">
                <div class="weather-particle" id="rain"></div>
                <div class="weather-particle" id="snow"></div>
                <div class="weather-particle" id="stars"></div>
            </div>
            
            <!-- å® ç‰©å®¹å™¨ -->
            <div id="pet-container">
                <div id="virtual-pet">
                    <span id="pet-emoji">ğŸ±</span>
                    <div id="pet-speech-bubble" class="speech-bubble hidden">
                        <span id="pet-speech-text">å–µ~</span>
                    </div>
                    <div id="pet-status">
                        <div class="status-bar">
                            <span>â¤ï¸</span>
                            <div class="status-bar-bg">
                                <div id="pet-happiness" class="status-bar-fill"></div>
                            </div>
                            <span id="happiness-text">100</span>
                        </div>
                        <div class="status-bar">
                            <span>ğŸ–</span>
                            <div class="status-bar-bg">
                                <div id="pet-hunger" class="status-bar-fill"></div>
                            </div>
                            <span id="hunger-text">100</span>
                        </div>
                        <div class="status-bar">
                            <span>ğŸ’¤</span>
                            <div class="status-bar-bg">
                                <div id="pet-energy" class="status-bar-fill"></div>
                            </div>
                            <span id="energy-text">100</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- äº’åŠ¨ç‰©å“ -->
            <div id="room-items">
                <div class="room-item" id="food-bowl" title="ç‚¹å‡»å–‚é£Ÿ">ğŸ¥£</div>
                <div class="room-item" id="toy-ball" title="ç‚¹å‡»ç©è€">âš½</div>
                <div class="room-item" id="bed" title="ç‚¹å‡»ä¼‘æ¯">ğŸ›ï¸</div>
                <div class="room-item" id="fish-tank" title="è§‚èµé±¼ç¼¸">ğŸ </div>
                <div class="room-item" id="plant" title="æµ‡èŠ±">ğŸŒ±</div>
                <div class="room-item" id="music-box" title="æ’­æ”¾éŸ³ä¹">ğŸµ</div>
            </div>
            
            <!-- ç‰¹æ•ˆå®¹å™¨ -->
            <div id="effects-container"></div>
        </div>
    </div>
    
    <!-- æ§åˆ¶é¢æ¿ -->
    <div id="pet-controls">
        <button class="pet-action-btn" id="feed-pet">ğŸ– å–‚é£Ÿ</button>
        <button class="pet-action-btn" id="play-pet">ğŸ¾ ç©è€</button>
        <button class="pet-action-btn" id="pet-sleep">ğŸ’¤ ä¼‘æ¯</button>
        <button class="pet-action-btn" id="change-pet">ğŸ”„ æ¢å® ç‰©</button>
        <button class="pet-action-btn" id="give-gift">ğŸ ç¤¼ç‰©</button>
        <button class="pet-action-btn" id="pet-bath">ğŸ› æ´—æ¾¡</button>
    </div>
    
    <!-- å¤©æ°”æ§åˆ¶ -->
    <div id="weather-controls">
        <h3>ğŸŒ¤ï¸ å¤©æ°”é­”æ³•</h3>
        <button class="weather-btn" data-weather="sunny">â˜€ï¸ æ™´å¤©</button>
        <button class="weather-btn" data-weather="rainy">ğŸŒ§ï¸ é›¨å¤©</button>
        <button class="weather-btn" data-weather="snowy">â„ï¸ é›ªå¤©</button>
        <button class="weather-btn" data-weather="starry">â­ æ˜Ÿç©º</button>
    </div>
    
    <!-- æˆ¿é—´ä¸»é¢˜ -->
    <div id="room-controls">
        <h3>ğŸ¨ æˆ¿é—´è£…é¥°</h3>
        <button class="room-theme-btn" data-room="cozy">ğŸ¡ æ¸©é¦¨å°å±‹</button>
        <button class="room-theme-btn" data-room="garden">ğŸŒ¸ èŠ±å›­å°å±‹</button>
        <button class="room-theme-btn" data-room="space">ğŸŒŒ æ˜Ÿç©ºå°å±‹</button>
        <button class="room-theme-btn" data-room="ocean">ğŸŒŠ æµ·æ´‹å°å±‹</button>
        <button class="room-theme-btn" data-room="candy">ğŸ­ ç³–æœå°å±‹</button>
        <button class="room-theme-btn" data-room="forest">ğŸŒ² æ£®æ—å°å±‹</button>
    </div>
    
    <!-- å® ç‰©ä¿¡æ¯é¢æ¿ -->
    <div id="pet-info-panel">
        <h3>ğŸ“Š <span id="pet-name">å°å’ª</span> çš„çŠ¶æ€</h3>
        <div class="pet-trait">
            <span class="trait-label">å¿ƒæƒ…ï¼š</span>
            <span id="pet-mood">ğŸ˜Š å¼€å¿ƒ</span>
        </div>
        <div class="pet-trait">
            <span class="trait-label">ç­‰çº§ï¼š</span>
            <span id="pet-level">Lv.1</span>
        </div>
        <div class="pet-trait">
            <span class="trait-label">ç»éªŒï¼š</span>
            <span id="pet-exp">0/100</span>
        </div>
    </div>
    
    <p class="placeholder-text">ï¼ˆå°å® ç‰©ç°åœ¨æ›´åŠ ç”ŸåŠ¨å¯çˆ±äº†ï¼è¯•è¯•ä¸å®ƒå’Œæˆ¿é—´çš„å„ç§äº’åŠ¨å§ï½ï¼‰</p>
</div>
     <div class="feature-section" id="theme-selector-area"><h2>ğŸ¨ ä¸»é¢˜é¢œè‰²é€‰æ‹©</h2><div class="theme-buttons"><button class="theme-btn pink" data-theme="pink">ç”œç”œç²‰</button><button class="theme-btn blue" data-theme="blue">å¤©ç©ºè“</button><button class="theme-btn green" data-theme="green">æ£®æ—ç»¿</button><button class="theme-btn orange" data-theme="orange">æ´»åŠ›æ©™</button><button class="theme-btn purple" data-theme="purple">æ˜Ÿç©ºç´«</button><button class="theme-btn yellow" data-theme="yellow">æŸ æª¬é»„</button><button class="theme-btn dark" data-theme="dark">æš—å¤œé»‘</button></div><p class="placeholder-text">ï¼ˆç‚¹å‡»æŒ‰é’®åˆ‡æ¢æ•´ä¸ªé¡µé¢çš„é¢œè‰²ä¸»é¢˜ï¼‰</p></div>
    <div class="feature-section" id="story-draw-area"><h2>âœ¨ æŠ½å–æ•…äº‹çš„æ–¹å¼</h2><div class="story-draw-methods"><div class="draw-method" id="draw-darts">ğŸ¯ é£é•–</div><div class="draw-method" id="draw-slot-machine">ğŸ° è€è™æœº</div><div class="draw-method" id="draw-coin-toss">ğŸª™ æŠ•å¸</div><div class="draw-method" id="draw-cat-paw">ğŸ¾ å–µçˆª</div><div class="draw-method" id="draw-balloon">ğŸˆ æ°”çƒ</div><div class="draw-method" id="draw-claw-machine">ğŸ§¸ å¨ƒå¨ƒæœº</div></div><p class="placeholder-text">ï¼ˆç‚¹å‡»æŒ‰é’®æŠ½å–æ•…äº‹ï¼‰</p></div>
    <div class="feature-section" id="persona-area"><h2>ğŸ­ æˆ‘çš„äººè®¾å¨ƒå¨ƒæœº</h2><div id="persona-claw-machine-trigger" class="persona-claw-machine"><span class="claw-emoji">ğŸ§¸</span><p>ç‚¹å‡»æŠ½å–ä»Šæ—¥äººè®¾ï¼</p></div><div id="persona-trait-display" class="persona-trait-display-area"><p class="placeholder-text">ä»Šå¤©ä¼šæ˜¯ä»€ä¹ˆæ ·çš„æˆ‘å‘¢ï¼Ÿ</p></div><button id="copy-persona-btn" class="copy-btn-section" title="å¤åˆ¶äººè®¾">ğŸ“‹ å¤åˆ¶ä»Šæ—¥äººè®¾</button><p class="placeholder-text" style="text-align:center; margin-top:10px;">ï¼ˆäººè®¾â€œå¥–å“â€ä¼šåœ¨æ•°æ®åŠ è½½åå¯ç”¨ï¼‰</p></div>
    <div class="feature-section" id="stamina-area"><h2>ğŸ’ª ä½“åŠ›å€¼</h2> <p>å½“å‰ä½“åŠ›ï¼š<span id="stamina-value-display">100</span> / 100</p> <div id="stamina-bar-container"><div id="stamina-bar">100%</div></div> <p class="placeholder-text">ï¼ˆæ¯æ¬¡æŠ½å–æ•…äº‹ä¼šæ¶ˆè€—ä½“åŠ›ï¼Œä½“åŠ›ä¼šç¼“æ…¢è‡ªåŠ¨æ¢å¤å“¦ï¼ï¼‰</p></div>
    <div class="feature-section" id="prompt-area"><h2>ğŸ’¡ PromptåŒº (çµæ„Ÿæ‘‡è›‹æœº)</h2> <button id="gacha-prompt-button" class="gacha-button">âœ¨ æ‘‡ä¸ªçµæ„Ÿï¼</button> <div id="prompt-gacha-display"><p class="placeholder-text">ç‚¹æŒ‰é’®æ‘‡Promptå§ï¼</p></div><button id="copy-prompt-btn" class="copy-btn-section" title="å¤åˆ¶çµæ„Ÿ">ğŸ“‹ å¤åˆ¶çµæ„Ÿ</button></div>
    <div class="feature-section" id="story-display-area"><h2>ğŸ“œ æ–‡æ¡ˆåŒº (æ•…äº‹å†…å®¹)</h2><div id="story-content"><p class="placeholder-text">æŠ½åˆ°çš„æ•…äº‹ä¼šæ˜¾ç¤ºåœ¨è¿™ï¼</p></div><button id="copy-story-btn" class="copy-btn-section" title="å¤åˆ¶æ•…äº‹">ğŸ“‹ å¤åˆ¶æ•…äº‹</button></div>
    <div class="feature-section" id="featured-modules-area"> <h2>ğŸ’– ç‰¹è‰²æ¨¡å—æ¢ç´¢</h2><div id="paperball-trigger">ğŸ“„ ç‚¹æˆ‘å±•å¼€é—®å·å…¥å£~</div> <div class="module-buttons-container"> <button class="module-btn" data-module="pureLove">çº¯çˆ±å°å±‹ ğŸŒ¸</button><button class="module-btn" data-module="privateRealm">ç¥ç§˜èŠ±å›­ ğŸ¤«</button> </div><div class="module-content" id="content-pureLove"><h3>æ¬¢è¿æ¥åˆ°çº¯çˆ±å°å±‹ <button class="copy-btn-module-all" id="pureLove-copy-all-btn" title="å¤åˆ¶æœ¬å±‹æ‰€æœ‰æ¡ç›®">ğŸ“‹ å¤åˆ¶å…¨éƒ¨</button></h3><div class="module-item-display" id="pureLove-item-display"><p class="placeholder-text">æ¨¡å—å†…å®¹åŠ è½½ä¸­æˆ–åŠ è½½å¤±è´¥...</p></div><div class="module-pagination-controls"><button class="pagination-btn prev" id="pureLove-prev-btn">&lt; ä¸Šä¸€é¡µ</button><span class="page-info" id="pureLove-page-info"></span><button class="pagination-btn next" id="pureLove-next-btn">ä¸‹ä¸€é¡µ &gt;</button></div><p class="placeholder-text" style="margin-top:15px;">ï¼ˆç‰¹è‰²æ¨¡å—æ¡ç›®ä¼šä»GiståŠ è½½ï¼‰</p></div><div class="module-content" id="content-privateRealm"><h3>æ¢ç´¢ç¥ç§˜èŠ±å›­ <button class="copy-btn-module-all" id="privateRealm-copy-all-btn" title="å¤åˆ¶æœ¬å›­æ‰€æœ‰æ¡ç›®">ğŸ“‹ å¤åˆ¶å…¨éƒ¨</button></h3><div class="module-item-display" id="privateRealm-item-display"><p class="placeholder-text">æ¨¡å—å†…å®¹åŠ è½½ä¸­æˆ–åŠ è½½å¤±è´¥...</p></div><div class="module-pagination-controls"><button class="pagination-btn prev" id="privateRealm-prev-btn">&lt; ä¸Šä¸€é¡µ</button><span class="page-info" id="privateRealm-page-info"></span><button class="pagination-btn next" id="privateRealm-next-btn">ä¸‹ä¸€é¡µ &gt;</button></div><p class="placeholder-text" style="margin-top:15px;">ï¼ˆç‰¹è‰²æ¨¡å—æ¡ç›®ä¼šä»GiståŠ è½½ï¼‰</p></div></div>

<script>
    // JavaScript é­”æ³•å¼€å§‹ï¼
    console.log("[é­”æ³•ä¹å›­æ—¥å¿— V14.2 Gisté“¾æ¥å†æ¬¡æ›´æ–°ç‰ˆ] è„šæœ¬å¼€å§‹è¿è¡Œï¼");
document.addEventListener('DOMContentLoaded', async function() {
    console.log("[é­”æ³•ä¹å›­æ—¥å¿— V14.2 Gisté“¾æ¥å†æ¬¡æ›´æ–°ç‰ˆ] DOMå®Œå…¨åŠ è½½ï¼Œå‡†å¤‡åŠ è½½å¤–éƒ¨æ•°æ®ã€‚");
    
// å‡çº§çš„å® ç‰©æ•°æ®
const pets = [
    { emoji: 'ğŸ±', name: 'å°å’ª', personality: 'æ´»æ³¼', favoriteFood: 'ğŸŸ' },
    { emoji: 'ğŸ¶', name: 'æ±ªæ±ª', personality: 'å¿ è¯š', favoriteFood: 'ğŸ¦´' },
    { emoji: 'ğŸ°', name: 'å…”å…”', personality: 'æ¸©æŸ”', favoriteFood: 'ğŸ¥•' },
    { emoji: 'ğŸ¹', name: 'ä»“é¼ ', personality: 'å¥½å¥‡', favoriteFood: 'ğŸŒ°' },
    { emoji: 'ğŸ¨', name: 'è€ƒæ‹‰', personality: 'æ‚ é—²', favoriteFood: 'ğŸƒ' },
    { emoji: 'ğŸ¼', name: 'ç†ŠçŒ«', personality: 'æ†¨åš', favoriteFood: 'ğŸ‹' },
    { emoji: 'ğŸ¦Š', name: 'å°ç‹', personality: 'èªæ˜', favoriteFood: 'ğŸ‡' },
    { emoji: 'ğŸº', name: 'å°ç‹¼', personality: 'ç‹¬ç«‹', favoriteFood: 'ğŸ¥©' }
];

// å® ç‰©å°è¯åº“
const petDialogues = {
    happy: ['å¥½å¼€å¿ƒå‘€ï¼', 'ä»Šå¤©å¿ƒæƒ…è¶…æ£’ï¼', 'å’Œä½ åœ¨ä¸€èµ·çœŸå¥½ï½', 'æ„Ÿè§‰å……æ»¡äº†æ´»åŠ›ï¼'],
    hungry: ['è‚šå­å’•å’•å«äº†...', 'å¥½æƒ³åƒä¸œè¥¿å‘€', 'æœ‰å¥½åƒçš„å—ï¼Ÿ', 'ä¸»äººï¼Œæˆ‘é¥¿äº†ï½'],
    sleepy: ['å¥½å›°å‘€...', 'zzz...', 'æƒ³ç¡è§‰äº†', 'çœ¼çš®å¥½é‡'],
    excited: ['å¤ªæ£’äº†ï¼', 'å“‡ï¼å¥½å‰å®³ï¼', 'å¥½æœ‰è¶£å‘€ï¼', 'å†æ¥ä¸€æ¬¡ï¼'],
    love: ['æœ€å–œæ¬¢ä½ äº†ï¼', 'â¤ï¸', 'æŠ±æŠ±ï½', 'æ°¸è¿œé™ªç€ä½ '],
    playful: ['ä¸€èµ·ç©å§ï¼', 'å¥½æ— èŠå‘€ï½', 'æ¥ç©æ¸¸æˆï¼', 'é™ªæˆ‘ç©å˜›ï¼'],
    greeting: ['ä½ å¥½å‘€ï¼', 'æƒ³æˆ‘äº†å—ï¼Ÿ', 'ä»Šå¤©è¿‡å¾—æ€ä¹ˆæ ·ï¼Ÿ', 'ä¸»äººå›æ¥äº†ï¼']
};

// å‡çº§çš„å® ç‰©çŠ¶æ€
let petState = {
    currentPetIndex: 0,
    happiness: 100,
    hunger: 100,
    energy: 100,
    level: 1,
    exp: 0,
    lastInteraction: Date.now(),
    room: 'cozy',
    weather: 'sunny',
    mood: 'happy',
    coins: 100,
    ownedItems: [],
    equippedItems: { hat: null, clothes: null, accessory: null }
};

// ä»æœ¬åœ°å­˜å‚¨åŠ è½½å® ç‰©çŠ¶æ€
function loadPetState() {
    try {
        const saved = localStorage.getItem('magicGarden_petState');
        if (saved) {
            const parsedState = JSON.parse(saved);
            petState = { ...petState, ...parsedState };
            
            // è®¡ç®—ç¦»çº¿æ—¶é—´é€ æˆçš„çŠ¶æ€å˜åŒ–
            const timeDiff = Date.now() - petState.lastInteraction;
            const hoursOffline = timeDiff / (1000 * 60 * 60);
            
            if (hoursOffline > 0.5) {
                petState.hunger = Math.max(0, petState.hunger - Math.floor(hoursOffline * 8));
                petState.happiness = Math.max(0, petState.happiness - Math.floor(hoursOffline * 4));
                petState.energy = Math.max(0, petState.energy - Math.floor(hoursOffline * 5));
            }
        }
    } catch (e) {
        console.warn('å® ç‰©çŠ¶æ€åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤çŠ¶æ€');
    }
}

// ä¿å­˜å® ç‰©çŠ¶æ€
function savePetState() {
    try {
        petState.lastInteraction = Date.now();
        localStorage.setItem('magicGarden_petState', JSON.stringify(petState));
    } catch (e) {
        console.warn('å® ç‰©çŠ¶æ€ä¿å­˜å¤±è´¥');
    }
}

// å® ç‰©å¿ƒæƒ…ç³»ç»Ÿ
function updatePetMood() {
    const { happiness, hunger, energy } = petState;
    const average = (happiness + hunger + energy) / 3;
    
    if (average >= 80) {
        petState.mood = 'happy';
    } else if (average >= 60) {
        petState.mood = 'content';
    } else if (average >= 40) {
        petState.mood = 'tired';
    } else if (hunger < 30) {
        petState.mood = 'hungry';
    } else if (energy < 30) {
        petState.mood = 'sleepy';
    } else {
        petState.mood = 'sad';
    }
    
    updatePetMoodDisplay();
}

// æ›´æ–°å¿ƒæƒ…æ˜¾ç¤º
function updatePetMoodDisplay() {
    const moodElement = document.getElementById('pet-mood');
    if (!moodElement) return;
    
    const moodEmojis = {
        happy: 'ğŸ˜Š å¼€å¿ƒ',
        content: 'ğŸ˜Œ æ»¡è¶³',
        tired: 'ğŸ˜´ ç–²æƒ«',
        hungry: 'ğŸ˜‹ é¥¥é¥¿',
        sleepy: 'ğŸ’¤ å›°å€¦',
        sad: 'ğŸ˜¢ ä¼¤å¿ƒ',
        excited: 'ğŸ¤© å…´å¥‹'
    };
    
    moodElement.textContent = moodEmojis[petState.mood] || 'ğŸ˜Š å¼€å¿ƒ';
}

// æ˜¾ç¤ºå® ç‰©è¯­éŸ³æ°”æ³¡
function showPetSpeech(message, duration = 3000) {
    const speechBubble = document.getElementById('pet-speech-bubble');
    const speechText = document.getElementById('pet-speech-text');
    
    if (!speechBubble || !speechText) return;
    
    speechText.textContent = message;
    speechBubble.classList.remove('hidden');
    
    setTimeout(() => {
        speechBubble.classList.add('hidden');
    }, duration);
}

// å® ç‰©è¯´è¯
function petSpeak(category = null) {
    let messages;
    
    if (category && petDialogues[category]) {
        messages = petDialogues[category];
    } else {
        // æ ¹æ®å½“å‰å¿ƒæƒ…é€‰æ‹©å°è¯
        switch (petState.mood) {
            case 'hungry':
                messages = petDialogues.hungry;
                break;
            case 'sleepy':
                messages = petDialogues.sleepy;
                break;
            case 'happy':
                messages = petDialogues.happy;
                break;
            default:
                messages = petDialogues.happy;
        }
    }
    
    const randomMessage = messages[Math.floor(Math.random() * messages.length)];
    showPetSpeech(randomMessage);
}

// åˆ›å»ºæµ®åŠ¨ç‰¹æ•ˆ
function createFloatingEffect(x, y, emoji, className = '') {
    const effect = document.createElement('div');
    effect.className = `floating-effect ${className}`;
    effect.textContent = emoji;
    effect.style.left = x + 'px';
    effect.style.top = y + 'px';
    
    const effectsContainer = document.getElementById('effects-container');
    if (effectsContainer) {
        effectsContainer.appendChild(effect);
        
        setTimeout(() => {
            if (effect.parentNode) {
                effect.parentNode.removeChild(effect);
            }
        }, 2000);
    }
}

// å‡çº§ç»éªŒç³»ç»Ÿ
function gainExp(amount = 10) {
    petState.exp += amount;
    const expNeeded = petState.level * 100;
    
    if (petState.exp >= expNeeded) {
        petState.level++;
        petState.exp = 0;
        
        // å‡çº§ç‰¹æ•ˆ
        const petContainer = document.getElementById('pet-container');
        if (petContainer) {
            createFloatingEffect(
                petContainer.offsetLeft + 50,
                petContainer.offsetTop + 30,
                'â­',
                'heart-effect'
            );
        }
        
        showPetSpeech('å‡çº§äº†ï¼Level Up! â­');
        playPetAnimation('pet-excited', 1200);
    }
    
    updatePetInfoDisplay();
}

// å® ç‰©äº’åŠ¨åŠ¨ç”»
function playPetAnimation(animationClass, duration = 1000) {
    const petContainer = document.getElementById('pet-container');
    if (petContainer) {
        petContainer.classList.add(animationClass);
        setTimeout(() => {
            petContainer.classList.remove(animationClass);
        }, duration);
    }
}

// æ›´æ–°å® ç‰©æ˜¾ç¤º
function updatePetDisplay() {
    const petEmoji = document.getElementById('pet-emoji');
    const happinessBar = document.getElementById('pet-happiness');
    const hungerBar = document.getElementById('pet-hunger');
    const happinessText = document.getElementById('happiness-text');
    const hungerText = document.getElementById('hunger-text');
    
    if (petEmoji) {
        petEmoji.textContent = pets[petState.currentPetIndex].emoji;
        petEmoji.title = pets[petState.currentPetIndex].name;
    }
    
    if (happinessBar && happinessText) {
        happinessBar.style.width = petState.happiness + '%';
        happinessText.textContent = petState.happiness;
        
        if (petState.happiness < 30) {
            happinessBar.style.background = 'linear-gradient(90deg, #e74c3c, #c0392b)';
        } else if (petState.happiness < 60) {
            happinessBar.style.background = 'linear-gradient(90deg, #f39c12, #e67e22)';
        } else {
            happinessBar.style.background = 'linear-gradient(90deg, #ff6b6b, #ff8e8e)';
        }
    }
    
    if (hungerBar && hungerText) {
        hungerBar.style.width = petState.hunger + '%';
        hungerText.textContent = petState.hunger;
        
        if (petState.hunger < 30) {
            hungerBar.style.background = 'linear-gradient(90deg, #e74c3c, #c0392b)';
        } else if (petState.hunger < 60) {
            hungerBar.style.background = 'linear-gradient(90deg, #f39c12, #e67e22)';
        } else {
            hungerBar.style.background = 'linear-gradient(90deg, #4ecdc4, #6ee8dd)';
        }
    }
    
    updatePetActionButtons();
    updatePetMood();
    savePetState();
}

// æ›´æ–°å® ç‰©æ“ä½œæŒ‰é’®çŠ¶æ€
function updatePetActionButtons() {
    const feedBtn = document.getElementById('feed-pet');
    const playBtn = document.getElementById('play-pet');
    
    if (feedBtn) {
        feedBtn.disabled = petState.hunger >= 90;
        feedBtn.title = petState.hunger >= 90 ? 'å°å® ç‰©ä¸é¥¿å“¦ï¼' : 'ç»™å°å® ç‰©å–‚é£Ÿ';
    }
    
    if (playBtn) {
        playBtn.disabled = petState.happiness >= 90 || petState.energy < 20;
        playBtn.title = petState.happiness >= 90 ? 'å°å® ç‰©å¾ˆå¼€å¿ƒï¼' : (petState.energy < 20 ? 'å°å® ç‰©å¤ªç´¯äº†' : 'å’Œå°å® ç‰©ç©è€');
    }
}

// æ›´æ–°å® ç‰©ä¿¡æ¯æ˜¾ç¤º
function updatePetInfoDisplay() {
    const nameElement = document.getElementById('pet-name');
    const levelElement = document.getElementById('pet-level');
    const expElement = document.getElementById('pet-exp');
    const energyBar = document.getElementById('pet-energy');
    const energyText = document.getElementById('energy-text');
    
    if (nameElement) {
        nameElement.textContent = pets[petState.currentPetIndex].name;
    }
    
    if (levelElement) {
        levelElement.textContent = `Lv.${petState.level}`;
    }
    
    if (expElement) {
        const expNeeded = petState.level * 100;
        expElement.textContent = `${petState.exp}/${expNeeded}`;
    }
    
    if (energyBar && energyText) {
        energyBar.style.width = petState.energy + '%';
        energyText.textContent = petState.energy;
        
        if (petState.energy < 30) {
            energyBar.style.background = 'linear-gradient(90deg, #e74c3c, #c0392b)';
        } else if (petState.energy < 60) {
            energyBar.style.background = 'linear-gradient(90deg, #f39c12, #e67e22)';
        } else {
            energyBar.style.background = 'linear-gradient(90deg, #9c27b0, #e1bee7)';
        }
    }
}

// å‡çº§çš„å® ç‰©æ“ä½œåŠŸèƒ½
function setupUpgradedPetControls() {
    // å–‚é£ŸæŒ‰é’®
    const feedBtn = document.getElementById('feed-pet');
    if (feedBtn) {
        feedBtn.addEventListener('click', function() {
            if (petState.hunger < 90) {
                petState.hunger = Math.min(100, petState.hunger + 20);
                petState.happiness = Math.min(100, petState.happiness + 5);
                gainExp(10);
                playPetAnimation('pet-eating', 800);
                updatePetDisplay();
                petSpeak('happy');
                
                this.textContent = 'ğŸ– å¥½é¦™ï¼';
                setTimeout(() => {
                    this.textContent = 'ğŸ– å–‚é£Ÿ';
                }, 1500);
            }
        });
    }
    
    // ç©è€æŒ‰é’®
    const playBtn = document.getElementById('play-pet');
    if (playBtn) {
        playBtn.addEventListener('click', function() {
            if (petState.happiness < 90 && petState.energy > 20) {
                petState.happiness = Math.min(100, petState.happiness + 25);
                petState.energy = Math.max(0, petState.energy - 10);
                gainExp(15);
                playPetAnimation('pet-excited', 600);
                updatePetDisplay();
                petSpeak('playful');
                
                this.textContent = 'ğŸ¾ å¥½å¼€å¿ƒï¼';
                setTimeout(() => {
                    this.textContent = 'ğŸ¾ ç©è€';
                }, 1500);
            }
        });
    }
    
    // ä¼‘æ¯æŒ‰é’®
    const sleepBtn = document.getElementById('pet-sleep');
    if (sleepBtn) {
        sleepBtn.addEventListener('click', function() {
            petState.happiness = Math.min(100, petState.happiness + 10);
            petState.energy = Math.min(100, petState.energy + 30);
            gainExp(8);
            playPetAnimation('pet-sleepy', 2000);
            updatePetDisplay();
            petSpeak('sleepy');
            
            this.textContent = 'ğŸ’¤ zzz...';
            setTimeout(() => {
                this.textContent = 'ğŸ’¤ ä¼‘æ¯';
            }, 2000);
        });
    }
    
    // æ¢å® ç‰©æŒ‰é’®
    const changeBtn = document.getElementById('change-pet');
    if (changeBtn) {
        changeBtn.addEventListener('click', function() {
            petState.currentPetIndex = (petState.currentPetIndex + 1) % pets.length;
            updatePetDisplay();
            updatePetInfoDisplay();
            
            const newPet = pets[petState.currentPetIndex];
            this.textContent = `ğŸ”„ ${newPet.name}`;
            setTimeout(() => {
                this.textContent = 'ğŸ”„ æ¢å® ç‰©';
                petSpeak('greeting');
            }, 1500);
        });
    }
    
    // ç¤¼ç‰©æŒ‰é’®
    const giftBtn = document.getElementById('give-gift');
    if (giftBtn) {
        giftBtn.addEventListener('click', function() {
            const gifts = ['ğŸ', 'ğŸŒŸ', 'ğŸ’', 'ğŸ†', 'ğŸˆ'];
            const randomGift = gifts[Math.floor(Math.random() * gifts.length)];
            
            petState.happiness = Math.min(100, petState.happiness + 30);
            gainExp(20);
            
            const petContainer = document.getElementById('pet-container');
            if (petContainer) {
                createFloatingEffect(
                    petContainer.offsetLeft + Math.random() * 100,
                    petContainer.offsetTop + Math.random() * 50,
                    randomGift
                );
            }
            
            petSpeak('love');
            playPetAnimation('pet-excited', 1000);
            updatePetDisplay();
            
            this.textContent = 'ğŸ å¥½å¼€å¿ƒï¼';
            setTimeout(() => {
                this.textContent = 'ğŸ ç¤¼ç‰©';
            }, 2000);
        });
    }
    
    // æ´—æ¾¡æŒ‰é’®
    const bathBtn = document.getElementById('pet-bath');
    if (bathBtn) {
        bathBtn.addEventListener('click', function() {
            petState.happiness = Math.min(100, petState.happiness + 15);
            petState.energy = Math.min(100, petState.energy + 10);
            gainExp(10);
            
            // æ³¡æ³¡ç‰¹æ•ˆ
            const petContainer = document.getElementById('pet-container');
            if (petContainer) {
                for (let i = 0; i < 5; i++) {
                    setTimeout(() => {
                        createFloatingEffect(
                            petContainer.offsetLeft + Math.random() * 80,
                            petContainer.offsetTop + Math.random() * 60,
                            'ğŸ«§'
                        );
                    }, i * 200);
                }
            }
            
            petSpeak('happy');
            playPetAnimation('pet-dancing', 1500);
            updatePetDisplay();
            
            this.textContent = 'ğŸ› å¥½èˆ’æœï¼';
            setTimeout(() => {
                this.textContent = 'ğŸ› æ´—æ¾¡';
            }, 2500);
        });
    }
}

// å¤©æ°”ç³»ç»Ÿ
function setupWeatherSystem() {
    const weatherButtons = document.querySelectorAll('.weather-btn');
    
    weatherButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            const weather = this.dataset.weather;
            changeWeather(weather);
            
            weatherButtons.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
        });
    });
}

function changeWeather(weather) {
    petState.weather = weather;
    
    // ç§»é™¤æ‰€æœ‰å¤©æ°”æ•ˆæœ
    document.querySelectorAll('.weather-particle').forEach(particle => {
        particle.classList.remove('active');
    });
    
    // åº”ç”¨æ–°å¤©æ°”
    const weatherMap = {
        sunny: 'stars',
        rainy: 'rain',
        snowy: 'snow',
        starry: 'stars'
    };
    
    const weatherElement = document.getElementById(weatherMap[weather]);
    if (weatherElement) {
        weatherElement.classList.add('active');
    }
    
    // å® ç‰©å¯¹å¤©æ°”çš„ååº”
    const weatherReactions = {
        sunny: ['å¥½æ¸©æš–å‘€ï¼', 'é˜³å…‰çœŸèˆ’æœï¼', 'å¤©æ°”çœŸå¥½ï¼'],
        rainy: ['ä¸‹é›¨äº†å‘¢ï½', 'é›¨å£°å¥½å¬ï¼', 'æ¹¿æ¶¦çš„ç©ºæ°”'],
        snowy: ['å¥½å†·å‘€ï¼', 'é›ªèŠ±å¥½ç¾ï¼', 'æƒ³è¦æ¸©æš–çš„æŠ±æŠ±'],
        starry: ['æ˜Ÿæ˜Ÿå¥½æ¼‚äº®ï¼', 'å¤œæ™šçœŸç¾å¦™', 'è®¸ä¸ªæ„¿å§ï¼']
    };
    
    if (weatherReactions[weather]) {
        setTimeout(() => {
            showPetSpeech(weatherReactions[weather][Math.floor(Math.random() * weatherReactions[weather].length)]);
        }, 500);
    }
    
    savePetState();
}

// æˆ¿é—´ç‰©å“äº’åŠ¨
function setupRoomItemsInteraction() {
    // é±¼ç¼¸äº’åŠ¨
    const fishTank = document.getElementById('fish-tank');
    if (fishTank) {
        fishTank.addEventListener('click', function() {
            petState.happiness = Math.min(100, petState.happiness + 5);
            gainExp(5);
            
            createFloatingEffect(
                this.offsetLeft,
                this.offsetTop,
                'ğŸ '
            );
            
            showPetSpeech(['å¥½æ¼‚äº®çš„é±¼ï¼', 'æ¸¸æ¥æ¸¸å»ï½', 'æƒ³å’Œé±¼é±¼ç©'][Math.floor(Math.random() * 3)]);
            updatePetDisplay();
        });
    }
    
    // æ¤ç‰©äº’åŠ¨
    const plant = document.getElementById('plant');
    if (plant) {
        plant.addEventListener('click', function() {
            petState.energy = Math.min(100, petState.energy + 8);
            gainExp(5);
            
            createFloatingEffect(
                this.offsetLeft,
                this.offsetTop,
                'ğŸ’§'
            );
            
            this.style.transform = 'scale(1.2)';
            setTimeout(() => {
                this.style.transform = 'scale(1)';
            }, 500);
            
            showPetSpeech(['ç©ºæ°”æ›´æ¸…æ–°äº†ï¼', 'ç»¿è‰²çœŸèˆ’æœ', 'æ¤ç‰©é•¿é«˜äº†'][Math.floor(Math.random() * 3)]);
            updatePetDisplay();
        });
    }
    
    // éŸ³ä¹ç›’äº’åŠ¨
    const musicBox = document.getElementById('music-box');
    if (musicBox) {
        musicBox.addEventListener('click', function() {
            petState.happiness = Math.min(100, petState.happiness + 10);
            gainExp(8);
            
            // éŸ³ç¬¦ç‰¹æ•ˆ
            const notes = ['ğŸµ', 'ğŸ¶', 'â™ª', 'â™«'];
            for (let i = 0; i < 4; i++) {
                setTimeout(() => {
                    createFloatingEffect(
                        this.offsetLeft + Math.random() * 30,
                        this.offsetTop + Math.random() * 30,
                        notes[Math.random() * notes.length | 0]
                    );
                }, i * 300);
            }
            
            showPetSpeech(['å¥½å¬çš„éŸ³ä¹ï¼', 'æƒ³è¦è·³èˆï½', 'å¿ƒæƒ…å˜å¥½äº†'][Math.floor(Math.random() * 3)]);
            playPetAnimation('pet-dancing', 2000);
            updatePetDisplay();
        });
    }
    
    // å¢å¼ºåŸæœ‰ç‰©å“
    const foodBowl = document.getElementById('food-bowl');
    if (foodBowl) {
        foodBowl.addEventListener('click', function() {
            if (petState.hunger < 90) {
                petState.hunger = Math.min(100, petState.hunger + 25);
                petState.happiness = Math.min(100, petState.happiness + 5);
                gainExp(10);
                
                createFloatingEffect(
                    this.offsetLeft,
                    this.offsetTop,
                    pets[petState.currentPetIndex].favoriteFood
                );
                
                petSpeak('happy');
                playPetAnimation('pet-eating', 1500);
                updatePetDisplay();
            }
        });
    }
    
    const toyBall = document.getElementById('toy-ball');
    if (toyBall) {
        toyBall.addEventListener('click', function() {
            if (petState.happiness < 90 && petState.energy > 20) {
                petState.happiness = Math.min(100, petState.happiness + 20);
                petState.energy = Math.max(0, petState.energy - 10);
                gainExp(15);
                
                this.style.transform = 'scale(1.3) translateY(-10px)';
                setTimeout(() => {
                    this.style.transform = 'scale(1)';
                }, 300);
                
                createFloatingEffect(
                    this.offsetLeft,
                    this.offsetTop,
                    'âš¡'
                );
                
                petSpeak('playful');
                playPetAnimation('pet-excited', 1000);
                updatePetDisplay();
            }
        });
    }
    
    const bed = document.getElementById('bed');
    if (bed) {
        bed.addEventListener('click', function() {
            if (petState.energy < 90) {
                petState.energy = Math.min(100, petState.energy + 30);
                petState.happiness = Math.min(100, petState.happiness + 10);
                gainExp(8);
                
                createFloatingEffect(
                    this.offsetLeft,
                    this.offsetTop,
                    'ğŸ’¤'
                );
                
                petSpeak('sleepy');
                playPetAnimation('pet-sleepy', 3000);
                updatePetDisplay();
            }
        });
    }
}

// æˆ¿é—´ä¸»é¢˜åˆ‡æ¢
function setupRoomControls() {
    const roomThemeButtons = document.querySelectorAll('.room-theme-btn');
    const roomBackground = document.getElementById('room-background');
    
    if (roomThemeButtons.length > 0 && roomBackground) {
        roomThemeButtons.forEach(btn => {
            btn.addEventListener('click', function() {
                const theme = this.dataset.room;
                
                roomBackground.className = '';
                roomBackground.classList.add(`room-theme-${theme}`);
                
                roomThemeButtons.forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                
                petState.room = theme;
                savePetState();
                
                const originalText = this.textContent;
                this.textContent = this.textContent + ' âœ¨';
                setTimeout(() => {
                    this.textContent = originalText;
                }, 1000);
            });
        });
        
        const savedThemeBtn = document.querySelector(`[data-room="${petState.room}"]`);
        if (savedThemeBtn) {
            savedThemeBtn.click();
        }
    }
}

// å¢å¼ºçš„å® ç‰©ç‚¹å‡»äº’åŠ¨
function setupPetInteraction() {
    const virtualPet = document.getElementById('virtual-pet');
    if (virtualPet) {
        virtualPet.addEventListener('click', function(e) {
            const reactions = ['âœ¨', 'ğŸ’•', 'ğŸŒŸ', 'ğŸ’–', 'ğŸ‰', 'ğŸŒˆ', 'â­'];
            const randomReaction = reactions[Math.floor(Math.random() * reactions.length)];
            
            // ä½¿ç”¨æˆ¿é—´å†…çš„å›ºå®šåæ ‡
const petContainer = document.getElementById('pet-container');
const containerRect = petContainer.getBoundingClientRect();
const roomRect = document.getElementById('effects-container').getBoundingClientRect();
const x = containerRect.left - roomRect.left + 50;
const y = containerRect.top - roomRect.top + 30;

createFloatingEffect(x, y, randomReaction, 'heart-effect');
            
            petState.happiness = Math.min(100, petState.happiness + 3);
            gainExp(3);
            updatePetDisplay();
            
            if (Math.random() < 0.4) {
                petSpeak();
            }
            
            const animations = ['pet-excited', 'pet-dancing'];
            if (Math.random() < 0.3) {
                playPetAnimation(animations[Math.floor(Math.random() * animations.length)], 800);
            }
        });
    }
}

// éšæœºäº‹ä»¶ç³»ç»Ÿ
function setupRandomEvents() {
    setInterval(() => {
        if (Math.random() < 0.1) {
            triggerRandomEvent();
        }
    }, 30000);
}

function triggerRandomEvent() {
    const events = [
        {
            message: 'å‘ç°äº†é—ªäº®çš„æ˜Ÿæ˜Ÿï¼',
            effect: () => {
                petState.happiness = Math.min(100, petState.happiness + 15);
                gainExp(20);
                createFloatingEffect(150, 100, 'â­', 'heart-effect');
            }
        },
        {
            message: 'æ‰¾åˆ°äº†ç¾å‘³çš„é£Ÿç‰©ï¼',
            effect: () => {
                petState.hunger = Math.min(100, petState.hunger + 20);
                createFloatingEffect(150, 100, 'ğŸ');
            }
        },
        {
            message: 'æ„Ÿå—åˆ°äº†ä¸»äººçš„çˆ±ï¼',
            effect: () => {
                petState.happiness = Math.min(100, petState.happiness + 25);
                createFloatingEffect(150, 100, 'ğŸ’•', 'heart-effect');
            }
        }
    ];
    
    const randomEvent = events[Math.floor(Math.random() * events.length)];
    showPetSpeech(randomEvent.message);
    randomEvent.effect();
    updatePetDisplay();
}

// è‡ªåŠ¨çŠ¶æ€è¡°å‡
function startPetStatusDecay() {
    setInterval(() => {
        let decayRate = 1;
        
        if (petState.weather === 'rainy') decayRate *= 0.8;
        if (petState.weather === 'snowy') decayRate *= 1.2;
        
        const hour = new Date().getHours();
        if (hour >= 22 || hour <= 6) {
            decayRate *= 0.5;
        }
        
        if (petState.hunger > 0) {
            petState.hunger = Math.max(0, petState.hunger - decayRate);
        }
        if (petState.happiness > 0) {
            petState.happiness = Math.max(0, petState.happiness - decayRate * 0.5);
        }
        if (petState.energy > 0) {
            petState.energy = Math.max(0, petState.energy - decayRate * 0.3);
        }
        
        updatePetDisplay();
        
        if (petState.hunger < 20 && Math.random() < 0.3) {
            petSpeak('hungry');
        } else if (petState.energy < 20 && Math.random() < 0.3) {
            petSpeak('sleepy');
        }
        
    }, 10000);
}

// åˆå§‹åŒ–æ‰€æœ‰å‡çº§åŠŸèƒ½
function initUpgradedPetSystem() {
    console.log('æ­£åœ¨åˆå§‹åŒ–å‡çº§çš„å® ç‰©ç³»ç»Ÿ...');
    
    loadPetState();
    updatePetDisplay();
    updatePetInfoDisplay();
    updatePetMood();
    
    setupUpgradedPetControls();
    setupRoomItemsInteraction();
    setupWeatherSystem();
    setupRoomControls();
    setupPetInteraction();
    setupRandomEvents();
    startPetStatusDecay();
    
    // è®¾ç½®é»˜è®¤å¤©æ°”
    const defaultWeatherBtn = document.querySelector('.weather-btn[data-weather="sunny"]');
    if (defaultWeatherBtn) {
        defaultWeatherBtn.classList.add('active');
    }
    
    // åº”ç”¨ä¿å­˜çš„å¤©æ°”
    if (petState.weather) {
        changeWeather(petState.weather);
        const savedWeatherBtn = document.querySelector(`[data-weather="${petState.weather}"]`);
        if (savedWeatherBtn) {
            document.querySelectorAll('.weather-btn').forEach(btn => btn.classList.remove('active'));
            savedWeatherBtn.classList.add('active');
        }
    }
    
    // åˆå§‹é—®å€™
    setTimeout(() => {
        petSpeak('greeting');
    }, 1000);
    
    // æ¯å°æ—¶è‡ªåŠ¨ä¿å­˜ä¸€æ¬¡
    setInterval(() => {
        savePetState();
    }, 60 * 60 * 1000);
    
      //åˆå§‹åŒ–å•†åº—ç³»ç»Ÿ
      initShopSystem();
      startCoinSystem();
console.log('å‡çº§çš„å® ç‰©ç³»ç»Ÿå·²åˆå§‹åŒ–å®Œæˆï¼');
    console.log('å½“å‰å® ç‰©çŠ¶æ€:', petState);
}

// é¢å¤–çš„è¾…åŠ©å‡½æ•°
function getPetPersonality() {
    return pets[petState.currentPetIndex].personality;
}

function getPetFavoriteFood() {
    return pets[petState.currentPetIndex].favoriteFood;
}

// å® ç‰©çŠ¶æ€æ£€æŸ¥å‡½æ•°
function checkPetNeeds() {
    const warnings = [];
    
    if (petState.hunger < 30) {
        warnings.push('å® ç‰©é¥¿äº†ï¼');
    }
    if (petState.happiness < 30) {
        warnings.push('å® ç‰©ä¸å¼€å¿ƒï¼');
    }
    if (petState.energy < 30) {
        warnings.push('å® ç‰©ç´¯äº†ï¼');
    }
    
    return warnings;
}

// å® ç‰©æŠ¤ç†å»ºè®®
function getPetCareAdvice() {
    const advice = [];
    
    if (petState.hunger < 50) {
        advice.push('ç»™å® ç‰©å–‚ç‚¹' + pets[petState.currentPetIndex].favoriteFood);
    }
    if (petState.happiness < 50) {
        advice.push('å’Œå® ç‰©ç©è€æˆ–ç»™å®ƒç¤¼ç‰©');
    }
    if (petState.energy < 50) {
        advice.push('è®©å® ç‰©ä¼‘æ¯ä¸€ä¸‹');
    }
    if (petState.level < 5) {
        advice.push('å¤šäº’åŠ¨å¯ä»¥è®©å® ç‰©å‡çº§å“¦');
    }
    
    return advice.length > 0 ? advice : ['å® ç‰©çŠ¶æ€å¾ˆå¥½ï¼Œç»§ç»­ä¿æŒï¼'];
}

// å¯¼å‡ºå® ç‰©æ•°æ®ï¼ˆå¯é€‰åŠŸèƒ½ï¼‰
function exportPetData() {
    const petData = {
        ...petState,
        petInfo: pets[petState.currentPetIndex],
        exportTime: new Date().toLocaleString(),
        version: 'v14.3'
    };
    
    const dataStr = JSON.stringify(petData, null, 2);
    console.log('å® ç‰©æ•°æ®å¯¼å‡º:', dataStr);
    
    // å¯ä»¥åˆ›å»ºä¸‹è½½é“¾æ¥
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `pet_data_${new Date().getTime()}.json`;
    a.click();
    URL.revokeObjectURL(url);
}

// é‡ç½®å® ç‰©æ•°æ®ï¼ˆæ…ç”¨ï¼‰
function resetPetData() {
    if (confirm('ç¡®å®šè¦é‡ç½®å® ç‰©æ•°æ®å—ï¼Ÿè¿™ä¼šæ¸…é™¤æ‰€æœ‰è¿›åº¦ï¼')) {
        localStorage.removeItem('magicGarden_petState');
        petState = {
            currentPetIndex: 0,
            happiness: 100,
            hunger: 100,
            energy: 100,
            level: 1,
            exp: 0,
            lastInteraction: Date.now(),
            room: 'cozy',
            weather: 'sunny',
            mood: 'happy'
        };
        updatePetDisplay();
        updatePetInfoDisplay();
        updatePetMood();
        showPetSpeech('é‡æ–°å¼€å§‹ï¼');
    }
}

// è°ƒè¯•å‡½æ•°ï¼ˆå¼€å‘æ—¶ä½¿ç”¨ï¼‰
function debugPetSystem() {
    console.log('=== å® ç‰©ç³»ç»Ÿè°ƒè¯•ä¿¡æ¯ ===');
    console.log('å½“å‰å® ç‰©:', pets[petState.currentPetIndex]);
    console.log('å® ç‰©çŠ¶æ€:', petState);
    console.log('æŠ¤ç†å»ºè®®:', getPetCareAdvice());
    console.log('çŠ¶æ€è­¦å‘Š:', checkPetNeeds());
    console.log('DOMå…ƒç´ æ£€æŸ¥:');
    console.log('- å® ç‰©å®¹å™¨:', !!document.getElementById('virtual-pet'));
    console.log('- è¯­éŸ³æ°”æ³¡:', !!document.getElementById('pet-speech-bubble'));
    console.log('- ç‰¹æ•ˆå®¹å™¨:', !!document.getElementById('effects-container'));
    console.log('- å¤©æ°”æŒ‰é’®:', document.querySelectorAll('.weather-btn').length);
    console.log('====================');
}
    const rootElement = document.documentElement;
    if (!rootElement) console.error("[LOG] CRITICAL: rootElement (html) æœªæ‰¾åˆ°!");

    // --- Gist Raw URLS (ä½¿ç”¨ç”œç”œæœ€æ–°æä¾›çš„é“¾æ¥) ---
    // å°gä¿®æ”¹å¤„1ï¼šç§»é™¤äº† MODULE_DATA_GIST_URL å‰é¢çš„ç©ºæ ¼
    const PROMPTS_GIST_URL = 'https://gist.githubusercontent.com/123g-stack/44ba2dc940723c1cc3adfe65445321a4/raw/23221be277a73165140aea8e97f8f10e93c5779e/prompts.json';
    const STORIES_GIST_URL = 'https://gist.githubusercontent.com/123g-stack/9143bd88dd6cd7c88d0d5efe3d131645/raw/5aa850b34c7e93fedf03a4978e6bad5646fd048e/stories.json';
    const PERSONA_ITEMS_GIST_URL = 'https://gist.githubusercontent.com/123g-stack/e0667bc86614abdc92d12254997b369d/raw/2be6b93bbc222baa9ea2cc164c81929890c30f8f/personaItems.json';
    const MODULE_DATA_GIST_URL = 'https://gist.githubusercontent.com/123g-stack/45afe17dbd91ebb37a6daffb1debb30a/raw/d95659d0ccbae794fa692d6f7b0b99fef1034157/moduleData.json';

    // --- åˆå§‹åŒ–æ•°æ®å˜é‡ (ç”¨å¤‡ç”¨æ•°æ®ä½œä¸ºåˆå§‹å€¼å’ŒåŠ è½½å¤±è´¥çš„åå¤‡) ---
    let prompts = ["åŠ è½½ä¸­ï¼Œè¯·ç¨å€™..."];
    let stories = { common: [{title:"åŠ è½½ä¸­...", content:"è¯·ç¨å€™..."}] };
    let personaItems = ["åŠ è½½ä¸­ï¼Œè¯·ç¨å€™..."];
    let moduleData = {
        pureLove: { items: ["åŠ è½½ä¸­..."], currentPage: 1 },
        privateRealm: { items: ["åŠ è½½ä¸­..."], currentPage: 1 }
    };
    let allDataLoadedSuccessfully = true; 

    // --- UIå…ƒç´ è·å– ---
    const promptGachaDisplay = document.getElementById('prompt-gacha-display');
    const storyDisplayContentElement = document.getElementById('story-content');
    const personaTraitDisplay = document.getElementById('persona-trait-display');
    const pureLoveItemDisplay = document.getElementById('pureLove-item-display');
    const privateRealmItemDisplay = document.getElementById('privateRealm-item-display');

    // --- å¼‚æ­¥åŠ è½½æ•°æ®çš„å‡½æ•° ---
    async function fetchData(url, fallbackData, dataName) {
        if (dataName === 'Prompts' && promptGachaDisplay) promptGachaDisplay.innerHTML = '<p class="loading-message">çµæ„ŸåŠ è½½ä¸­...</p>';
        if (dataName === 'Stories' && storyDisplayContentElement) storyDisplayContentElement.innerHTML = '<p class="loading-message">æ•…äº‹åŠ è½½ä¸­...</p>';
        if (dataName === 'PersonaItems' && personaTraitDisplay) personaTraitDisplay.innerHTML = '<p class="loading-message">äººè®¾åŠ è½½ä¸­...</p>';
        if (dataName === 'ModuleData') {
            if(pureLoveItemDisplay) pureLoveItemDisplay.innerHTML = '<p class="loading-message">çº¯çˆ±å°å±‹å†…å®¹åŠ è½½ä¸­...</p>';
            if(privateRealmItemDisplay) privateRealmItemDisplay.innerHTML = '<p class="loading-message">ç¥ç§˜èŠ±å›­å†…å®¹åŠ è½½ä¸­...</p>';
        }

        try {
            // æ³¨æ„ï¼šurl.trim() å¯ä»¥å¸®åŠ©å»é™¤ URL å‰åçš„ç©ºç™½å­—ç¬¦ï¼Œå¢å¼ºå¥å£®æ€§
            if (url.trim() === '' || url.includes("ã€") || url.includes("å ä½ç¬¦")) {
                console.warn(`[LOG] ${dataName}ä½¿ç”¨çš„æ˜¯å ä½ç¬¦URLæˆ–URLä¸ºç©º ('${url}')ï¼Œå°†ä½¿ç”¨å¤‡ç”¨æ•°æ®ã€‚`);
                throw new Error('Placeholder or empty URL for ' + dataName);
            }
            const response = await fetch(url.trim(), { cache: "no-store" }); // å°gä¿®æ”¹å¤„2ï¼šfetch(url.trim(), ...) ç¡®ä¿å»é™¤URLå‰åçš„ç©ºæ ¼
            if (!response.ok) {
                throw new Error(`ç½‘ç»œè¯·æ±‚ ${dataName} å¤±è´¥: ${response.status} ${response.statusText} (URL: ${url})`);
            }
            const jsonData = await response.json();
            console.log(`[LOG] ${dataName} æ•°æ®å·²æˆåŠŸä»GiståŠ è½½ï¼ å†…å®¹ç‰‡æ®µ:`, JSON.stringify(jsonData).substring(0,100));
            return jsonData;
        } catch (error) {
            console.error(`[LOG] åŠ è½½ ${dataName} æ•°æ®å¤±è´¥:`, error.message, `å°†ä½¿ç”¨å¤‡ç”¨æ•°æ®ã€‚`);
            allDataLoadedSuccessfully = false; 
            return fallbackData;
        }
    }

    // --- ç­‰å¾…æ‰€æœ‰æ ¸å¿ƒæ•°æ®åŠ è½½å®Œæˆ ---
    try {
        [
            prompts,
            stories,
            personaItems,
            moduleData
        ] = await Promise.all([
            fetchData(PROMPTS_GIST_URL, ["å¤‡ç”¨æç¤º1ï¼šGisté“¾æ¥æ— æ•ˆæˆ–ç½‘ç»œä¸ä½³ã€‚", "å¤‡ç”¨æç¤º2ï¼šè¯·æ£€æŸ¥Gisté“¾æ¥ã€‚"], 'Prompts'),
            fetchData(STORIES_GIST_URL, { common: [{title:"å¤‡ç”¨æ•…äº‹", content:"Gisté“¾æ¥æ— æ•ˆæˆ–ç½‘ç»œä¸ä½³ã€‚"}] }, 'Stories'),
            fetchData(PERSONA_ITEMS_GIST_URL, ["å¤‡ç”¨äººè®¾1ï¼šGisté“¾æ¥å¯èƒ½æ— æ•ˆã€‚", "å¤‡ç”¨äººè®¾2ï¼šæ£€æŸ¥ç½‘ç»œã€‚"], 'PersonaItems'),
            fetchData(MODULE_DATA_GIST_URL, { 
                pureLove: { items: ["å¤‡ç”¨çº¯çˆ±æ¡ç›®ï¼šGisté“¾æ¥é—®é¢˜ã€‚"], currentPage: 1 }, 
                privateRealm: { items: ["å¤‡ç”¨ç¥ç§˜æ¡ç›®ï¼šGisté“¾æ¥é—®é¢˜ã€‚"], currentPage: 1 } 
            }, 'ModuleData')
        ]);
        
        console.log("[LOG] æ‰€æœ‰æ ¸å¿ƒå¤–éƒ¨æ•°æ®å‡å·²å°è¯•åŠ è½½å®Œæ¯•ï¼");
        console.log("[LOG] Prompts åŠ è½½å: ", prompts);
        console.log("[LOG] Stories åŠ è½½å: ", stories);
        console.log("[LOG] PersonaItems åŠ è½½å: ", personaItems);
        console.log("[LOG] ModuleData åŠ è½½å: ", moduleData);


        if(promptGachaDisplay) promptGachaDisplay.innerHTML = '<p class="placeholder-text">ç‚¹æŒ‰é’®æ‘‡Promptå§ï¼</p>';
        if(storyDisplayContentElement) storyDisplayContentElement.innerHTML = '<p class="placeholder-text">æŠ½åˆ°çš„æ•…äº‹ä¼šæ˜¾ç¤ºåœ¨è¿™ï¼</p>';
        if(personaTraitDisplay) personaTraitDisplay.innerHTML = '<p class="placeholder-text">ä»Šå¤©ä¼šæ˜¯ä»€ä¹ˆæ ·çš„æˆ‘å‘¢ï¼Ÿ</p>';
        
        const activeButton = document.querySelector('.module-btn.active');
        if (activeButton) {
            const activeModule = activeButton.dataset.module;
            if (moduleData && moduleData[activeModule] && moduleData[activeModule].items && moduleData[activeModule].items.length > 0 && !(moduleData[activeModule].items.length > 0 && moduleData[activeModule].items[0].includes("å¤‡ç”¨"))) {
                moduleData[activeModule].currentPage = 1;
                displayModuleItems(activeModule); 
            } else { 
                const displayElement = document.getElementById(`${activeModule}-item-display`);
                if(displayElement) displayElement.innerHTML = `<p class="placeholder-text" style="color:red;">${activeModule} æ¨¡å—å†…å®¹åŠ è½½å¤±è´¥æˆ–ä¸ºç©º!</p>`;
            }
        } else { 
             if(pureLoveItemDisplay && document.getElementById('content-pureLove').style.display === 'block') {
                if (moduleData.pureLove && moduleData.pureLove.items && moduleData.pureLove.items.length > 0 && !(moduleData.pureLove.items.length > 0 && moduleData.pureLove.items[0].includes("å¤‡ç”¨"))) displayModuleItems('pureLove');
                else if(pureLoveItemDisplay) pureLoveItemDisplay.innerHTML = '<p class="placeholder-text">çº¯çˆ±å°å±‹å†…å®¹åŠ è½½å¤±è´¥æˆ–ä¸ºç©º...</p>';
             }
             if(privateRealmItemDisplay && document.getElementById('content-privateRealm').style.display === 'block'){
                if (moduleData.privateRealm && moduleData.privateRealm.items && moduleData.privateRealm.items.length > 0 && !(moduleData.privateRealm.items.length > 0 && moduleData.privateRealm.items[0].includes("å¤‡ç”¨"))) displayModuleItems('privateRealm');
                else if(privateRealmItemDisplay) privateRealmItemDisplay.innerHTML = '<p class="placeholder-text">ç¥ç§˜èŠ±å›­å†…å®¹åŠ è½½å¤±è´¥æˆ–ä¸ºç©º...</p>';
             }
        }

        // å°gä¿®æ”¹å¤„3ï¼šåœ¨æ‰€æœ‰æ•°æ®åŠ è½½æˆåŠŸåï¼Œä¸ºåˆ†é¡µæŒ‰é’®ç»‘å®šäº‹ä»¶
        setupPaginationControls('pureLove');
        setupPaginationControls('privateRealm');

    } catch (error) {
        console.error("[LOG] Promise.all åŠ è½½æ•°æ®æ—¶å‘ç”Ÿæ„å¤–é”™è¯¯:", error);
        allDataLoadedSuccessfully = false; 
        if(promptGachaDisplay) promptGachaDisplay.innerHTML = '<p class="placeholder-text" style="color:red;">éƒ¨åˆ†æ ¸å¿ƒæ•°æ®åŠ è½½å¤±è´¥ï¼ŒåŠŸèƒ½å¯èƒ½å—é™ã€‚</p>';
    }

    // =======================================================================
    //  é­”æ³•ä¹å›­çš„å…¶ä»–æ‰€æœ‰JavaScripté€»è¾‘ä»£ç  (åŸºäºV13ç‰ˆæœ¬)
    // =======================================================================

    // --- ä¸»é¢˜é¢œè‰²åˆ‡æ¢åŠŸèƒ½ ---
    const themeButtons = document.querySelectorAll('.theme-buttons .theme-btn');
    const themes = { 
            pink: { '--primary-bg-color': '#fff0f5', '--primary-text-color': '#5d3c50', '--theme-accent-color': '#ff69b4', '--feature-bg-color': '#ffffff', '--feature-border-color': '#ffc0cb', '--gacha-button-text-color': '#ffffff', '--draw-method-bg-color': '#ffe4e1', '--draw-method-border-color': '#ff69b4', '--draw-method-text-color': '#c71585', '--draw-method-hover-bg-color': '#ffb6c1', '--stamina-bar-bg-color': '#ff69b4', '--story-content-bg-color': '#fffafa', '--story-content-border-color': '#ffb6c1', '--placeholder-text-color': '#a07080', '--story-title-color': '#ff69b4', '--module-button-active-bg': '#ff69b4', '--module-button-active-text': '#ffffff', '--module-button-bg': '#ffe4e1', '--module-button-text': '#c71585', '--pagination-btn-bg': '#ff69b4', '--pagination-btn-text': '#ffffff', '--pagination-btn-disabled-bg': '#ffdbe7', '--pagination-btn-disabled-text': '#ff8cc6'},
            blue: { '--primary-bg-color': '#e0f7fa', '--primary-text-color': '#004d40', '--theme-accent-color': '#00bcd4', '--feature-bg-color': '#ffffff', '--feature-border-color': '#b2ebf2', '--gacha-button-text-color': '#004d40', '--draw-method-bg-color': '#e0f7fa', '--draw-method-border-color': '#00bcd4', '--draw-method-text-color': '#00796b', '--draw-method-hover-bg-color': '#b2ebf2', '--stamina-bar-bg-color': '#00acc1', '--story-content-bg-color': '#f0f8ff', '--story-content-border-color': '#81d4fa', '--placeholder-text-color': '#546e7a', '--story-title-color': '#00bcd4', '--module-button-active-bg': '#00bcd4', '--module-button-active-text': '#ffffff', '--module-button-bg': '#e0f7fa', '--module-button-text': '#00796b', '--pagination-btn-bg': '#00bcd4', '--pagination-btn-text': '#ffffff', '--pagination-btn-disabled-bg': '#b3e5fc', '--pagination-btn-disabled-text': '#007ac1'},
            green: {'--primary-bg-color': '#e8f5e9', '--primary-text-color': '#1b5e20', '--theme-accent-color': '#4caf50', '--feature-bg-color': '#ffffff', '--feature-border-color': '#c8e6c9', '--gacha-button-text-color': '#ffffff', '--draw-method-bg-color': '#e8f5e9', '--draw-method-border-color': '#4caf50', '--draw-method-text-color': '#2e7d32', '--draw-method-hover-bg-color': '#c8e6c9', '--stamina-bar-bg-color': '#388e3c', '--story-content-bg-color': '#f1f8e9', '--story-content-border-color': '#a5d6a7', '--placeholder-text-color': '#556b2f', '--story-title-color': '#4caf50', '--module-button-active-bg': '#4caf50', '--module-button-active-text': '#ffffff', '--module-button-bg': '#e8f5e9', '--module-button-text': '#2e7d32', '--pagination-btn-bg': '#4caf50', '--pagination-btn-text': '#ffffff', '--pagination-btn-disabled-bg': '#c8e6c9', '--pagination-btn-disabled-text': '#388e3c'},
            orange: {'--primary-bg-color': '#fff3e0', '--primary-text-color': '#e65100', '--theme-accent-color': '#ff9800', '--feature-bg-color': '#ffffff', '--feature-border-color': '#ffe0b2', '--gacha-button-text-color': '#8c0000', '--draw-method-bg-color': '#fff3e0', '--draw-method-border-color': '#ff9800', '--draw-method-text-color': '#f57c00', '--draw-method-hover-bg-color': '#ffe0b2', '--stamina-bar-bg-color': '#fb8c00', '--story-content-bg-color': '#fff8e1', '--story-content-border-color': '#ffcc80', '--placeholder-text-color': '#bf360c', '--story-title-color': '#ff9800', '--module-button-active-bg': '#ff9800', '--module-button-active-text': '#ffffff', '--module-button-bg': '#fff3e0', '--module-button-text': '#f57c00', '--pagination-btn-bg': '#ff9800', '--pagination-btn-text': '#ffffff', '--pagination-btn-disabled-bg': '#ffe0b2', '--pagination-btn-disabled-text': '#e65100'},
            purple: {'--primary-bg-color': '#f3e5f5', '--primary-text-color': '#4a148c', '--theme-accent-color': '#9c27b0', '--feature-bg-color': '#ffffff', '--feature-border-color': '#e1bee7', '--gacha-button-text-color': '#ffffff', '--draw-method-bg-color': '#f3e5f5', '--draw-method-border-color': '#9c27b0', '--draw-method-text-color': '#7b1fa2', '--draw-method-hover-bg-color': '#e1bee7', '--stamina-bar-bg-color': '#8e24aa', '--story-content-bg-color': '#f9f0ff', '--story-content-border-color': '#d1c4e9', '--placeholder-text-color': '#6a1b9a', '--story-title-color': '#9c27b0', '--module-button-active-bg': '#9c27b0', '--module-button-active-text': '#ffffff', '--module-button-bg': '#f3e5f5', '--module-button-text': '#7b1fa2', '--pagination-btn-bg': '#9c27b0', '--pagination-btn-text': '#ffffff', '--pagination-btn-disabled-bg': '#e1bee7', '--pagination-btn-disabled-text': '#6a1b9a'},
            yellow: {'--primary-bg-color': '#fffde7', '--primary-text-color': '#f57f17', '--theme-accent-color': '#fdd835', '--feature-bg-color': '#ffffff', '--feature-border-color': '#fff9c4', '--gacha-button-text-color': '#827717', '--draw-method-bg-color': '#fffde7', '--draw-method-border-color': '#fdd835', '--draw-method-text-color': '#fbc02d', '--draw-method-hover-bg-color': '#fff9c4', '--stamina-bar-bg-color': '#fbc02d', '--story-content-bg-color': '#floralwhite', '--story-content-border-color': '#fff59d', '--placeholder-text-color': '#b28704', '--story-title-color': '#fdd835', '--module-button-active-bg': '#fdd835', '--module-button-active-text': '#827717', '--module-button-bg': '#fffde7', '--module-button-text': '#fbc02d', '--pagination-btn-bg': '#fdd835', '--pagination-btn-text': '#827717', '--pagination-btn-disabled-bg': '#fff9c4', '--pagination-btn-disabled-text': '#c49000'},
            dark: { '--primary-bg-color': '#212121', '--primary-text-color': '#e0e0e0', '--theme-accent-color': '#757575', '--feature-bg-color': '#303030', '--feature-border-color': '#424242', '--gacha-button-text-color': '#ffffff', '--draw-method-bg-color': '#424242', '--draw-method-border-color': '#757575', '--draw-method-text-color': '#e0e0e0', '--draw-method-hover-bg-color': '#525252', '--stamina-bar-bg-color': '#616161', '--story-content-bg-color': '#262626', '--story-content-border-color': '#616161', '--placeholder-text-color': '#9e9e9e', '--story-title-color': '#757575', '--module-button-active-bg': '#757575', '--module-button-active-text': '#212121', '--module-button-bg': '#424242', '--module-button-text': '#e0e0e0', '--pagination-btn-bg': '#757575', '--pagination-btn-text': '#212121', '--pagination-btn-disabled-bg': '#424242', '--pagination-btn-disabled-text': '#9e9e9e'}
    };
    if (themeButtons.length > 0) { themeButtons.forEach(button => { button.addEventListener('click', function() { const themeName = this.dataset.theme; rootElement.style.setProperty('--current-theme-name', themeName); const selectedTheme = themes[themeName]; if (selectedTheme) { for (const variable in selectedTheme) { rootElement.style.setProperty(variable, selectedTheme[variable]); } } updateStaminaVisuals(); updateModuleButtonStyles(); updateAllPaginationButtonsStyle(); }); });} else { console.warn("[LOG] æœªæ‰¾åˆ°ä¸»é¢˜æŒ‰é’®ã€‚");}
    
    // --- ä½“åŠ›å€¼ç³»ç»Ÿ ---
    const staminaDisplayElement = document.getElementById('stamina-value-display'); const staminaBarElement = document.getElementById('stamina-bar'); let currentStamina = 100; const maxStamina = 100; const staminaCostPerDraw = 10; const staminaRegenAmount = 1; const staminaRegenInterval = 5000; function updateStaminaVisuals() { if (!staminaDisplayElement || !staminaBarElement) { return; } staminaDisplayElement.textContent = currentStamina; const percentage = (currentStamina / maxStamina) * 100; staminaBarElement.style.width = percentage + '%'; staminaBarElement.textContent = Math.round(percentage) + '%'; const currentThemeName = rootElement.style.getPropertyValue('--current-theme-name') || 'blue'; const currentThemeColors = themes[currentThemeName]; let staminaBarColor = currentThemeColors ? currentThemeColors['--stamina-bar-bg-color'] : '#00acc1'; if (percentage < 30) { staminaBarColor = '#d9534f'; } else if (percentage < 60) { staminaBarColor = '#f0ad4e'; } staminaBarElement.style.backgroundColor = staminaBarColor; const drawMethodButtons = document.querySelectorAll('.draw-method'); drawMethodButtons.forEach(btn => { if (currentStamina < staminaCostPerDraw) { btn.classList.add('disabled'); btn.title = "ä½“åŠ›ä¸è¶³å•¦ï¼"; } else { btn.classList.remove('disabled'); btn.title = ""; } }); } function regenerateStamina() { if (currentStamina < maxStamina) { currentStamina += staminaRegenAmount; if (currentStamina > maxStamina) { currentStamina = maxStamina; } updateStaminaVisuals(); } } setInterval(regenerateStamina, staminaRegenInterval); updateStaminaVisuals(); 
    
    // --- Promptæ‘‡è›‹æœº åŠŸèƒ½ ---
    const gachaPromptButton = document.getElementById('gacha-prompt-button');
    if (gachaPromptButton && promptGachaDisplay) { gachaPromptButton.addEventListener('click', function() { if (!allDataLoadedSuccessfully && prompts[0].includes("å¤‡ç”¨") ) { promptGachaDisplay.innerHTML = '<p class="loading-message">æç¤ºè¯è¿˜åœ¨åŠªåŠ›åŠ è½½ä¸­æˆ–åŠ è½½å¤±è´¥ï¼Œè¯·ç¨ç­‰æˆ–æ£€æŸ¥Gisté“¾æ¥~</p>'; return; } this.classList.add('shake-animation'); setTimeout(() => { this.classList.remove('shake-animation'); }, 500); if (!prompts || prompts.length === 0 || (prompts.length > 0 && prompts[0].includes("å¤‡ç”¨"))) { promptGachaDisplay.innerHTML = '<p class="placeholder-text" style="color:orange;">å“å‘€ï¼Œçµæ„Ÿæ± å¥½åƒç©ºäº†ï¼(æˆ–è€…æ²¡åŠ è½½æˆåŠŸ)</p>'; return; } const randomIndex = Math.floor(Math.random() * prompts.length); const randomPrompt = prompts[randomIndex]; promptGachaDisplay.innerHTML = ''; setTimeout(() => { const promptTextElement = document.createElement('p'); promptTextElement.textContent = randomPrompt; promptGachaDisplay.appendChild(promptTextElement); }, 150); }); } else { console.error("[LOG] æ‘‡è›‹æœºæŒ‰é’®æˆ–æ˜¾ç¤ºåŒºæœªæ‰¾åˆ°ã€‚"); }
    
    // --- æ•…äº‹æ•°æ®å’ŒæŠ½å–é€»è¾‘ ---
    if (!storyDisplayContentElement) console.error("[LOG] CRITICAL: storyDisplayContentElement æœªæ‰¾åˆ°!"); 
    function drawStory() { if (!allDataLoadedSuccessfully && stories.common && stories.common.length > 0 && stories.common[0]?.title === "å¤‡ç”¨æ•…äº‹" ) { storyDisplayContentElement.innerHTML = '<p class="loading-message">æ•…äº‹è¿˜åœ¨åŠªåŠ›åŠ è½½ä¸­æˆ–åŠ è½½å¤±è´¥ï¼Œè¯·ç¨ç­‰æˆ–æ£€æŸ¥Gisté“¾æ¥~</p>'; return; } if (!storyDisplayContentElement) { return; } if (currentStamina < staminaCostPerDraw) { storyDisplayContentElement.innerHTML = `<p class="placeholder-text" style="color: red; font-weight: bold;">ä½“åŠ›ä¸è¶³ï¼Œæ— æ³•æŠ½å–æ•…äº‹å•¦ï¼</p>`; return; } const rarityKeys = Object.keys(stories); if (rarityKeys.length === 0 || (rarityKeys.length === 1 && rarityKeys[0] === "common" && stories.common[0]?.title === "å¤‡ç”¨æ•…äº‹") ) { storyDisplayContentElement.innerHTML = `<p class="placeholder-text" style="color:orange;">æ•…äº‹ä¹¦æ˜¯ç©ºçš„ï¼(æˆ–è€…æ²¡åŠ è½½æˆåŠŸ)</p>`; return; } let randomRarityKey = rarityKeys[Math.floor(Math.random() * rarityKeys.length)]; let storiesInRarity = stories[randomRarityKey]; if (!storiesInRarity || storiesInRarity.length === 0) { // å¦‚æœæŸä¸ªç¨€æœ‰åº¦åˆ†ç±»æ˜¯ç©ºçš„ï¼Œå°è¯•ä¸‹ä¸€ä¸ª
        let attempts = 0;
        while ((!storiesInRarity || storiesInRarity.length === 0) && attempts < rarityKeys.length) {
            randomRarityKey = rarityKeys[Math.floor(Math.random() * rarityKeys.length)];
            storiesInRarity = stories[randomRarityKey];
            attempts++;
        }
        if (!storiesInRarity || storiesInRarity.length === 0) {
             storyDisplayContentElement.innerHTML = `<p class="placeholder-text" style="color:orange;">æ‰€æœ‰ç±»åˆ«çš„æ•…äº‹éƒ½æš‚æ—¶æ²¡æœ‰å“¦ï¼</p>`; return;
        }
    } let randomStory = storiesInRarity[Math.floor(Math.random() * storiesInRarity.length)]; if (!randomStory || typeof randomStory.title === 'undefined' || typeof randomStory.content === 'undefined') { storyDisplayContentElement.innerHTML = `<p class="placeholder-text" style="color:red;">æŠ½åˆ°ç©ºç™½é¡µï¼</p>`; return; } storyDisplayContentElement.innerHTML = `<h3>${randomStory.title}</h3><p>${randomStory.content}</p>`; currentStamina -= staminaCostPerDraw; updateStaminaVisuals(); } 
    function setupAnimatedDrawButton(buttonId, processingText, animationClass, animationDuration = 700) { const button = document.getElementById(buttonId); if (button && storyDisplayContentElement) { button.addEventListener('click', function() { if (this.classList.contains('disabled')) { return; } const originalText = this.innerHTML; const originalCursor = this.style.cursor; this.innerHTML = processingText || "æŠ½å–ä¸­..."; this.classList.add('disabled'); this.style.cursor = 'wait'; if (animationClass) { this.classList.add(animationClass); } if (currentStamina >= staminaCostPerDraw && allDataLoadedSuccessfully) { storyDisplayContentElement.innerHTML = `<p class="placeholder-text">æ­£åœ¨æŠ½å–...</p>`; } else if (!allDataLoadedSuccessfully) { storyDisplayContentElement.innerHTML = `<p class="loading-message">æ•°æ®åŠ è½½ä¸­/å¤±è´¥ï¼Œè¯·ç¨å...</p>`; } setTimeout(() => { if (animationClass) { this.classList.remove(animationClass); } drawStory(); this.innerHTML = originalText; this.style.cursor = originalCursor; if (currentStamina < staminaCostPerDraw) { this.classList.add('disabled');} else { this.classList.remove('disabled'); } }, animationDuration); }); } else { if (!button) console.error(`[LOG] åŠ¨ç”»æŒ‰é’® #${buttonId} æœªæ‰¾åˆ°`); } }
    setupAnimatedDrawButton('draw-darts', 'ğŸ¯ å‘½ä¸­ç›®æ ‡...', 'dart-throw-animation', 500); setupAnimatedDrawButton('draw-slot-machine', 'ğŸ° è½¬åŠ¨ä¸­...', 'slot-spin-animation', 600); setupAnimatedDrawButton('draw-coin-toss', 'ğŸª™ å‘½è¿ä¸€æ·...', 'coin-flip-animation', 700); setupAnimatedDrawButton('draw-cat-paw', 'ğŸ¾ å–µåŠ›å‡ºå‡»...', 'cat-paw-animation', 400); setupAnimatedDrawButton('draw-balloon', 'ğŸˆ æˆ³ç ´æƒŠå–œ...', 'balloon-wiggle-animation', 700); const clawMachineButton = document.getElementById('draw-claw-machine'); if (clawMachineButton && storyDisplayContentElement) { clawMachineButton.addEventListener('click', function() { if (this.classList.contains('disabled')) { return; } const originalText = this.innerHTML; const originalCursor = this.style.cursor; this.innerHTML = "ğŸ§¸ æŠ“å–ä¸­..."; this.classList.add('disabled'); this.style.cursor = 'wait'; this.classList.add('is-grabbing'); if (currentStamina >= staminaCostPerDraw && allDataLoadedSuccessfully) { storyDisplayContentElement.innerHTML = `<p class="placeholder-text">å¨ƒå¨ƒæœºåŠªåŠ›æŠ“å–ä¸­...</p>`;} else if (!allDataLoadedSuccessfully) { storyDisplayContentElement.innerHTML = `<p class="loading-message">æ•°æ®åŠ è½½ä¸­/å¤±è´¥ï¼Œè¯·ç¨å...</p>`; } setTimeout(() => { this.classList.remove('is-grabbing'); drawStory(); this.innerHTML = originalText; this.style.cursor = originalCursor; if (currentStamina < staminaCostPerDraw) { this.classList.add('disabled'); } else { this.classList.remove('disabled'); } }, 700); });}
    
    // --- äººè®¾å¨ƒå¨ƒæœºåŠŸèƒ½ ---
    const personaClawMachine = document.getElementById('persona-claw-machine-trigger');
    if (personaClawMachine && personaTraitDisplay) { personaClawMachine.addEventListener('click', function() { if (!allDataLoadedSuccessfully && personaItems[0].includes("å¤‡ç”¨") ) { personaTraitDisplay.innerHTML = '<p class="loading-message">äººè®¾è¿˜åœ¨åŠªåŠ›åŠ è½½ä¸­æˆ–åŠ è½½å¤±è´¥ï¼Œè¯·ç¨ç­‰æˆ–æ£€æŸ¥Gisté“¾æ¥~</p>'; return; } this.classList.add('persona-machine-shake'); personaTraitDisplay.innerHTML = '<p class="placeholder-text">æŠ“å–ä»Šæ—¥äººè®¾ä¸­...</p>'; setTimeout(() => { this.classList.remove('persona-machine-shake'); if (!personaItems || personaItems.length === 0 || (personaItems.length > 0 && personaItems[0].includes("å¤‡ç”¨"))) { personaTraitDisplay.innerHTML = '<p class="placeholder-text" style="color:orange;">äººè®¾æ± ç©ºå•¦ï¼(æˆ–è€…æ²¡åŠ è½½æˆåŠŸ)</p>'; return; } const randomIndex = Math.floor(Math.random() * personaItems.length); const randomPersonaTrait = personaItems[randomIndex]; personaTraitDisplay.innerHTML = ''; const traitTextElement = document.createElement('p'); traitTextElement.textContent = randomPersonaTrait; personaTraitDisplay.appendChild(traitTextElement); }, 700); }); } else { console.error("[LOG] äººè®¾å¨ƒå¨ƒæœºæˆ–æ˜¾ç¤ºåŒºæœªæ‰¾åˆ°ã€‚"); }
    
    // --- å¤åˆ¶æ–‡æœ¬åˆ°å‰ªè´´æ¿çš„è¾…åŠ©å‡½æ•° ---
    async function copyTextToClipboard(text, buttonElement, successMessage = 'å·²å¤åˆ¶ âœ“') { if (!text || text.trim() === '' || (buttonElement && buttonElement.textContent.includes('å·²å¤åˆ¶'))) { if (text.trim() === '' && buttonElement) { const originalText = buttonElement.dataset.originalText || buttonElement.textContent; buttonElement.textContent = 'å†…å®¹ä¸ºç©º!'; setTimeout(() => { buttonElement.textContent = originalText; }, 1500); } return; } const originalButtonText = buttonElement ? (buttonElement.dataset.originalText || buttonElement.innerHTML) : ''; if (buttonElement && !buttonElement.dataset.originalText) buttonElement.dataset.originalText = originalButtonText; try { await navigator.clipboard.writeText(text); if (buttonElement) { buttonElement.innerHTML = successMessage; buttonElement.classList.add('copied-feedback'); setTimeout(() => { buttonElement.innerHTML = originalButtonText; buttonElement.classList.remove('copied-feedback'); delete buttonElement.dataset.originalText; }, 2000); } } catch (err) { console.error('[LOG] å¤åˆ¶æ–‡æœ¬å¤±è´¥:', err); if (buttonElement) { buttonElement.innerHTML = 'å¤åˆ¶å¤±è´¥!'; setTimeout(() => { buttonElement.innerHTML = originalButtonText; delete buttonElement.dataset.originalText; }, 2000); } } }
    
    // --- å„åŒºåŸŸå¤åˆ¶æŒ‰é’®äº‹ä»¶ç›‘å¬ ---
    const copyPromptBtn = document.getElementById('copy-prompt-btn'); if (copyPromptBtn && promptGachaDisplay) { copyPromptBtn.addEventListener('click', function() { const promptTextElement = promptGachaDisplay.querySelector('p:not(.placeholder-text):not(.loading-message)'); const textToCopy = promptTextElement ? promptTextElement.textContent : ''; if (textToCopy.trim() !== '') { copyTextToClipboard(textToCopy.trim(), this, 'çµæ„Ÿå·²å¤åˆ¶!'); } else { copyTextToClipboard('', this); } }); }
    const copyStoryBtn = document.getElementById('copy-story-btn'); if (copyStoryBtn && storyDisplayContentElement) { copyStoryBtn.addEventListener('click', function() { const titleElement = storyDisplayContentElement.querySelector('h3'); const contentElement = storyDisplayContentElement.querySelector('p:not(.placeholder-text):not(.loading-message)'); let textToCopy = ""; if (titleElement) textToCopy += titleElement.textContent.trim(); if (contentElement) { if (textToCopy !== "") textToCopy += "\n\n"; textToCopy += contentElement.textContent.trim(); } if (textToCopy.trim() !== '') { copyTextToClipboard(textToCopy, this, 'æ•…äº‹å·²å¤åˆ¶!'); } else { copyTextToClipboard('', this); } }); }
    const copyPersonaBtn = document.getElementById('copy-persona-btn'); if (copyPersonaBtn && personaTraitDisplay) { copyPersonaBtn.addEventListener('click', function() { const personaTextElement = personaTraitDisplay.querySelector('p:not(.placeholder-text):not(.loading-message)'); const textToCopy = personaTextElement ? personaTextElement.textContent : ''; if (textToCopy.trim() !== '') { copyTextToClipboard(textToCopy.trim(), this, 'äººè®¾å·²å¤åˆ¶!'); } else { copyTextToClipboard('', this); } }); }
    
    // --- ç‰¹è‰²æ¨¡å—åˆ‡æ¢åŠŸèƒ½ ---
    const paperballTrigger = document.getElementById('paperball-trigger'); const moduleButtonsContainer = document.querySelector('.module-buttons-container'); const moduleContents = document.querySelectorAll('.module-content'); const moduleButtons = document.querySelectorAll('.module-btn');
    const itemsPerPage = 2; 
    if (paperballTrigger && moduleButtonsContainer) { paperballTrigger.addEventListener('click', function() { if (moduleButtonsContainer.style.display === 'none' || moduleButtonsContainer.style.display === '') { moduleButtonsContainer.style.display = 'flex'; this.textContent = 'ğŸ“„ æ”¶èµ·é—®å·å…¥å£~';} else { moduleButtonsContainer.style.display = 'none'; this.textContent = 'ğŸ“„ ç‚¹æˆ‘å±•å¼€é—®å·å…¥å£~'; moduleContents.forEach(content => content.style.display = 'none'); moduleButtons.forEach(btn => btn.classList.remove('active')); updateModuleButtonStyles(); }}); } else { console.error("[LOG] çº¸å›¢æˆ–æ¨¡å—æŒ‰é’®å®¹å™¨æœªæ‰¾åˆ°ã€‚"); }
    function displayModuleItems(moduleName) { if (!allDataLoadedSuccessfully && (!moduleData[moduleName] || !moduleData[moduleName].items || (moduleData[moduleName].items.length > 0 && moduleData[moduleName].items[0].includes("å¤‡ç”¨"))) ) { const displayElement = document.getElementById(`${moduleName}-item-display`); if(displayElement) displayElement.innerHTML = '<p class="loading-message">æ¨¡å—å†…å®¹è¿˜åœ¨åŠªåŠ›åŠ è½½ä¸­æˆ–åŠ è½½å¤±è´¥ï¼Œè¯·ç¨ç­‰æˆ–æ£€æŸ¥Gisté“¾æ¥~</p>'; return; } const moduleConfig = moduleData[moduleName]; if (!moduleConfig || !moduleConfig.items) { console.error(`[LOG] æ¨¡å—æ•°æ® ${moduleName} æˆ–å…¶ items æœªæ‰¾åˆ°/åŠ è½½æˆåŠŸ`); const displayElement = document.getElementById(`${moduleName}-item-display`); if(displayElement) displayElement.innerHTML = '<p class="placeholder-text" style="color:red;">æ¨¡å—å†…å®¹åŠ è½½å¤±è´¥!</p>'; return; } const displayElement = document.getElementById(`${moduleName}-item-display`);
        const pageInfoElement = document.getElementById(`${moduleName}-page-info`);
        const prevButton = document.getElementById(`${moduleName}-prev-btn`);
        const nextButton = document.getElementById(`${moduleName}-next-btn`);
        if (!displayElement || !pageInfoElement || !prevButton || !nextButton) {
            console.error(`[LOG] æ¨¡å— ${moduleName} DOMå…ƒç´ ä¸å…¨`); return;
        }

        displayElement.innerHTML = '';
        const startIndex = (moduleConfig.currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const paginatedItems = moduleConfig.items.slice(startIndex, endIndex);

        if (paginatedItems.length === 0 && moduleConfig.items.length > 0 && !(moduleConfig.items.length > 0 && moduleConfig.items[0].includes("å¤‡ç”¨"))) {
            displayElement.innerHTML = `<p class="placeholder-text">å·²ç»æ˜¯æœ€åä¸€é¡µå•¦ï¼</p>`;
        } else if (moduleConfig.items.length === 0 || (moduleConfig.items.length > 0 && moduleConfig.items[0].includes("å¤‡ç”¨") && (!allDataLoadedSuccessfully || moduleConfig.items[0].includes("åŠ è½½ä¸­")))) {
            displayElement.innerHTML = `<p class="placeholder-text">è¿™ä¸ªæ¨¡å—è¿˜æ²¡æœ‰å†…å®¹å“¦~ï¼ˆæˆ–åŠ è½½å¤±è´¥ï¼‰</p>`;
        } else {
            paginatedItems.forEach(itemText => {
                const p = document.createElement('p');
                const textSpan = document.createElement('span');
                textSpan.textContent = itemText;
                p.appendChild(textSpan);
                const copyForItemButton = document.createElement('button');
                copyForItemButton.textContent = 'ğŸ“‹';
                copyForItemButton.title = 'å¤åˆ¶æ­¤æ¡';
                copyForItemButton.classList.add('copy-btn-item');
                copyForItemButton.addEventListener('click', function(event) {
                    event.stopPropagation();
                    copyTextToClipboard(itemText, this, 'æ­¤æ¡å·²å¤åˆ¶!');
                });
                p.appendChild(copyForItemButton);
                displayElement.appendChild(p);
            });
        }
        
        const totalPages = Math.ceil(moduleConfig.items.length / itemsPerPage) || 1;
        pageInfoElement.textContent = `ç¬¬ ${moduleConfig.currentPage} / ${totalPages} é¡µ`;
        prevButton.disabled = moduleConfig.currentPage === 1;
        nextButton.disabled = moduleConfig.currentPage >= totalPages || moduleConfig.items.length === 0 || (moduleConfig.items.length > 0 && moduleConfig.items[0].includes("å¤‡ç”¨")); // å°gä¿®æ”¹å¤„4ï¼šnextButton.disabled çš„åˆ¤æ–­æ¡ä»¶ï¼ŒcurrentPage >= totalPages æ›´ä¸¥è°¨
        updatePaginationButtonStyles(moduleName);
    } // displayModuleItems å‡½æ•°çš„ç»“æŸæ‹¬å·

    ['pureLove', 'privateRealm'].forEach(moduleName => { const copyAllBtn = document.getElementById(`${moduleName}-copy-all-btn`); if (copyAllBtn) { copyAllBtn.addEventListener('click', function() { if (!allDataLoadedSuccessfully && (!moduleData[moduleName] || !moduleData[moduleName].items || (moduleData[moduleName].items.length > 0 && moduleData[moduleName].items[0].includes("å¤‡ç”¨"))) ) { alert('æ¨¡å—å†…å®¹è¿˜åœ¨åŠ è½½ä¸­æˆ–åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åå†è¯•å“¦ï¼'); return;} const itemsToCopy = moduleData[moduleName] ? moduleData[moduleName].items : []; if (itemsToCopy && itemsToCopy.length > 0 && !(itemsToCopy.length > 0 && itemsToCopy[0].includes("å¤‡ç”¨"))) { const allItemsText = itemsToCopy.join('\n\n'); copyTextToClipboard(allItemsText, this, 'å…¨éƒ¨å·²å¤åˆ¶!'); } else { copyTextToClipboard('', this); } }); } else { console.warn(`[LOG] '${moduleName}-copy-all-btn' æœªæ‰¾åˆ°ã€‚`); } });
    if (moduleButtons.length > 0 && moduleContents.length > 0) { moduleButtons.forEach(button => { button.addEventListener('click', function() { const targetModule = this.dataset.module; if (!targetModule) { console.error("[LOG] é”™è¯¯ï¼targetModule æœªå®šä¹‰ï¼"); return; } let foundTargetContent = false; moduleContents.forEach(content => { if (content.id === `content-${targetModule}`) { foundTargetContent = true; const isActive = content.style.display === 'block'; content.style.display = isActive ? 'none' : 'block'; if (!isActive) { if (moduleData && moduleData[targetModule]) { moduleData[targetModule].currentPage = 1; try { displayModuleItems(targetModule); } catch (e) { console.error("[LOG] displayModuleItems è°ƒç”¨æ—¶å‘ç”Ÿé”™è¯¯:", e); } } else { console.error("[LOG] é”™è¯¯ï¼moduleData æˆ– moduleData['" + targetModule + "'] æœªå®šä¹‰ï¼"); const displayElement = document.getElementById(`${targetModule}-item-display`); if(displayElement) displayElement.innerHTML = '<p class="loading-message" style="color:red;">æ¨¡å—æ•°æ®åŠ è½½å¤±è´¥!</p>';} } } else { content.style.display = 'none'; } }); if (!foundTargetContent && targetModule) { console.error("[LOG] ä¸¥é‡é”™è¯¯ï¼æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„ content divï¼"); } moduleButtons.forEach(btn => { const moduleDiv = document.getElementById(`content-${btn.dataset.module}`); if (moduleDiv && moduleDiv.style.display === 'block') { btn.classList.add('active'); } else { btn.classList.remove('active'); } }); try { updateModuleButtonStyles(); } catch (e) { console.error("[LOG] updateModuleButtonStyles è°ƒç”¨æ—¶å‘ç”Ÿé”™è¯¯:", e); } }); }); } else { console.warn("[LOG] æœªæ‰¾åˆ°æ¨¡å—æŒ‰é’®æˆ–æ¨¡å—å†…å®¹åŒºåŸŸã€‚"); }

    // å°gä¿®æ”¹å¤„5ï¼šæ–°å¢ setupPaginationControls å‡½æ•°ï¼Œç”¨äºç»‘å®šåˆ†é¡µæŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
    function setupPaginationControls(moduleName) {
    const prevButton = document.getElementById(`${moduleName}-prev-btn`);
    const nextButton = document.getElementById(`${moduleName}-next-btn`);
    const moduleConfig = moduleData[moduleName];

    if (!prevButton || !nextButton || !moduleConfig) {
        console.warn(`æœªèƒ½ä¸º ${moduleName} è®¾ç½®åˆ†é¡µæ§ä»¶äº‹ä»¶ï¼Œç¼ºå°‘å…ƒç´ æˆ–æ•°æ®ã€‚`);
        return;
    }

    // æ£€æŸ¥æ˜¯å¦å·²ç»ç»‘å®šè¿‡äº‹ä»¶
    if (prevButton.hasAttribute('data-pagination-initialized')) {
        return;
    }

    // æ ‡è®°å·²åˆå§‹åŒ–
    prevButton.setAttribute('data-pagination-initialized', 'true');
    nextButton.setAttribute('data-pagination-initialized', 'true');

    // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
    prevButton.addEventListener('click', function() {
        if (moduleConfig.currentPage > 1) {
            moduleConfig.currentPage--;
            displayModuleItems(moduleName);
        }
    });

    nextButton.addEventListener('click', function() {
        const totalPages = Math.ceil(moduleConfig.items.length / itemsPerPage) || 1;
        if (moduleConfig.currentPage < totalPages) {
            moduleConfig.currentPage++;
            displayModuleItems(moduleName);
        }
    });
}


    function updatePaginationButtonStyles(moduleName) { const prevButton = document.getElementById(`${moduleName}-prev-btn`); const nextButton = document.getElementById(`${moduleName}-next-btn`); if (!prevButton || !nextButton) return; const currentThemeName = rootElement.style.getPropertyValue('--current-theme-name') || 'blue'; const currentThemeColors = themes[currentThemeName]; if (!currentThemeColors) return;[prevButton, nextButton].forEach(btn => { if (btn.disabled) { btn.style.backgroundColor = currentThemeColors['--pagination-btn-disabled-bg']; btn.style.color = currentThemeColors['--pagination-btn-disabled-text']; } else { btn.style.backgroundColor = currentThemeColors['--pagination-btn-bg']; btn.style.color = currentThemeColors['--pagination-btn-text']; } }); }
    function updateAllPaginationButtonsStyle() { if (moduleData.pureLove && moduleData.pureLove.items && moduleData.pureLove.items.length > 0 && !(moduleData.pureLove.items.length > 0 && moduleData.pureLove.items[0].includes("å¤‡ç”¨"))) updatePaginationButtonStyles('pureLove'); if (moduleData.privateRealm && moduleData.privateRealm.items && moduleData.privateRealm.items.length > 0 && !(moduleData.privateRealm.items.length > 0 && moduleData.privateRealm.items[0].includes("å¤‡ç”¨"))) updatePaginationButtonStyles('privateRealm'); } 
    function updateModuleButtonStyles() { const currentThemeName = rootElement.style.getPropertyValue('--current-theme-name') || 'blue'; const currentThemeColors = themes[currentThemeName]; if (!currentThemeColors) return; moduleButtons.forEach(btn => { if (btn.classList.contains('active')) { btn.style.backgroundColor = currentThemeColors['--module-button-active-bg']; btn.style.color = currentThemeColors['--module-button-active-text']; } else { btn.style.backgroundColor = currentThemeColors['--module-button-bg']; btn.style.color = currentThemeColors['--module-button-text']; } }); }
    function setDefaultTheme() { const defaultThemeName = 'blue'; rootElement.style.setProperty('--current-theme-name', defaultThemeName); const defaultTheme = themes[defaultThemeName]; if (defaultTheme) { for (const variable in defaultTheme) { rootElement.style.setProperty(variable, defaultTheme[variable]); } } updateStaminaVisuals(); updateModuleButtonStyles(); updateAllPaginationButtonsStyle(); console.log("[LOG] é»˜è®¤ä¸»é¢˜ (Blue) å·²åº”ç”¨ã€‚"); }
    
    setDefaultTheme();
    // åˆå§‹åŒ–å® ç‰©ç³»ç»Ÿ
initUpgradedPetSystem();
    console.log("[é­”æ³•ä¹å›­æ—¥å¿— V14.2 æœ€æ–°æ•°æ®é“¾æ¥ç‰ˆ] æ ¸å¿ƒè„šæœ¬æ‰§è¡Œå®Œæ¯•ï¼Œäº‹ä»¶ç›‘å¬å™¨å·²è®¾ç½®ã€‚æ•°æ®æ­£åœ¨ä»Gistå¼‚æ­¥åŠ è½½...");
});
</script>
</body>
</html>
